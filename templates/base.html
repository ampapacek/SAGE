<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SAGE</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/sage.png') }}" />
    <style>
      :root {
        --bg: #f5f5f5;
        --card: #ffffff;
        --text: #222222;
        --muted: #666666;
        --border: #dddddd;
        --header-bg: #222222;
        --header-text: #ffffff;
        --link: #1b6ef3;
        --accent: #1b6ef3;
        --secondary: #555555;
        --danger: #b00020;
        --flash-bg: #fff6cc;
        --flash-border: #e5d58c;
        --input-bg: #ffffff;
        --pre-bg: #f7f7f7;
        --table-border: #eeeeee;
        --status-draft: #555555;
        --status-approved: #1b6ef3;
        --status-archived: #999999;
        --status-generating: #b36b00;
        --status-error: #c00000;
        --status-cancelled: #777777;
        --status-success: #00aa77;
        --file-bg: #fafafa;
        --file-border: #bbbbbb;
        --file-hover-bg: #f0f6ff;
      }
      @media (prefers-color-scheme: dark) {
        :root {
          --bg: #0f1115;
          --card: #171a21;
          --text: #e6e8ee;
          --muted: #a7adba;
          --border: #2a2f3a;
          --header-bg: #0c2b45;
          --header-text: #e6e8ee;
          --link: #7db1ff;
          --accent: #3b82f6;
          --secondary: #4b5563;
          --danger: #f87171;
          --flash-bg: #2a2412;
          --flash-border: #5b4a16;
          --input-bg: #0f131a;
          --pre-bg: #11161d;
          --table-border: #232833;
          --status-draft: #9ca3af;
          --status-approved: #7db1ff;
          --status-archived: #6b7280;
          --status-generating: #f59e0b;
          --status-error: #f87171;
          --status-cancelled: #9ca3af;
          --status-success: #34d399;
          --file-bg: #0f131a;
          --file-border: #3b4150;
          --file-hover-bg: #0f1a2a;
        }
      }
      html[data-theme="dark"] {
        --bg: #0f1115;
        --card: #171a21;
        --text: #e6e8ee;
        --muted: #a7adba;
        --border: #2a2f3a;
        --header-bg: #0c2b45;
        --header-text: #e6e8ee;
        --link: #7db1ff;
        --accent: #3b82f6;
        --secondary: #4b5563;
        --danger: #f87171;
        --flash-bg: #2a2412;
        --flash-border: #5b4a16;
        --input-bg: #0f131a;
        --pre-bg: #11161d;
        --table-border: #232833;
        --status-draft: #9ca3af;
        --status-approved: #7db1ff;
        --status-archived: #6b7280;
        --status-generating: #f59e0b;
        --status-error: #f87171;
        --status-cancelled: #9ca3af;
        --status-success: #34d399;
        --file-bg: #0f131a;
        --file-border: #3b4150;
        --file-hover-bg: #0f1a2a;
      }
      html[data-theme="light"] {
        --bg: #f5f5f5;
        --card: #ffffff;
        --text: #222222;
        --muted: #666666;
        --border: #dddddd;
        --header-bg: #222222;
        --header-text: #ffffff;
        --link: #1b6ef3;
        --accent: #1b6ef3;
        --secondary: #555555;
        --danger: #b00020;
        --flash-bg: #fff6cc;
        --flash-border: #e5d58c;
        --input-bg: #ffffff;
        --pre-bg: #f7f7f7;
        --table-border: #eeeeee;
        --status-draft: #555555;
        --status-approved: #1b6ef3;
        --status-archived: #999999;
        --status-generating: #b36b00;
        --status-error: #c00000;
        --status-cancelled: #777777;
        --status-success: #00aa77;
        --file-bg: #fafafa;
        --file-border: #bbbbbb;
        --file-hover-bg: #f0f6ff;
      }
      body { font-family: Arial, sans-serif; margin: 0; background: var(--bg); color: var(--text); }
      header { background: var(--header-bg); color: var(--header-text); padding: 12px 20px; display: flex; align-items: center; justify-content: space-between; gap: 12px; }
      header a { color: var(--header-text); text-decoration: none; }
      .logo { display: inline-flex; align-items: center; gap: 12px; font-weight: 700; letter-spacing: 0.02em; }
      .logo img { height: 90px; width: 90px; max-height: 90px; max-width: 90px; object-fit: contain; display: block; }
      .hero-logo { width: 128px; height: 128px; max-width: 128px; max-height: 128px; object-fit: contain; display: block; }
      .home-button { background: var(--accent); padding: 10px 18px; border-radius: 999px; display: inline-flex; align-items: center; justify-content: center; min-height: 46px; color: #fff; font-weight: 600; font-size: 14px; }
      .back-button { background: rgba(255, 255, 255, 0.08); padding: 10px 18px; border-radius: 999px; border: 1px solid rgba(255, 255, 255, 0.18); color: #fff; cursor: pointer; font-weight: 600; font-size: 14px; min-height: 46px; display: inline-flex; align-items: center; justify-content: center; }
      .theme-toggle { background: rgba(255, 255, 255, 0.08); border: 1px solid rgba(255, 255, 255, 0.18); color: var(--header-text); padding: 10px; border-radius: 999px; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; overflow: hidden; min-height: 46px; min-width: 46px; }
      .theme-toggle:hover { background: rgba(255, 255, 255, 0.16); }
      .theme-toggle img { width: 34px; height: 34px; display: block; transform: scale(2.7); transform-origin: center; }
      .icon-link { width: 46px; height: 46px; border: 1px solid rgba(255, 255, 255, 0.18); border-radius: 999px; display: inline-flex; align-items: center; justify-content: center; color: var(--header-text); background: rgba(255, 255, 255, 0.08); padding: 0; overflow: hidden; cursor: pointer; }
      .icon-link img { width: 34px; height: 34px; display: block; transform: scale(2.4); transform-origin: center; }
      .icon-link:hover { background: rgba(255, 255, 255, 0.16); }
      .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); border: 0; }
      .nav-buttons { display: flex; gap: 12px; align-items: center; }
      main { max-width: 1300px; margin: 20px auto; padding: 0 20px 40px; }
      h1, h2, h3 { margin: 0 0 12px; }
      .card { background: var(--card); padding: 16px; border-radius: 6px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
      .card.attention { border: 1px solid var(--accent); box-shadow: 0 0 0 1px rgba(27, 110, 243, 0.12), 0 1px 3px rgba(0,0,0,0.1); }
      form label { display: block; font-weight: bold; margin: 10px 0 6px; }
      input[type="text"], textarea, select { display: block; width: 100%; max-width: 1040px; padding: 8px; border: 1px solid var(--border); background: var(--input-bg); color: var(--text); border-radius: 4px; box-sizing: border-box; }
      .compact-select { max-width: 360px; }
      .settings-input { max-width: 520px; }
      textarea { min-height: 140px; resize: vertical; font-size: 17px; line-height: 1.55; }
      button { margin-top: 10px; padding: 8px 14px; border: none; background: var(--accent); color: #fff; border-radius: 4px; cursor: pointer; }
      button.secondary { background: var(--secondary); }
      button.danger { background: var(--danger); }
      .action-link { display: inline-flex; align-items: center; justify-content: center; padding: 6px 12px; border-radius: 6px; background: var(--accent); color: #fff; text-decoration: none; font-weight: 600; font-size: 13px; border: 1px solid transparent; }
      .action-link:hover { filter: brightness(0.95); }
      .file-input { width: 100%; max-width: 1040px; padding: 18px; border: 2px dashed var(--file-border); border-radius: 6px; background: var(--file-bg); color: var(--text); cursor: pointer; box-sizing: border-box; transition: border-color 0.15s ease, background-color 0.15s ease; }
      .file-input:hover { border-color: var(--accent); background: var(--file-hover-bg); }
      .dropzone { margin-bottom: 12px; }
      .dropzone.active .file-input { border-color: var(--accent); background: var(--file-hover-bg); }
      .dropzone-hint { margin-top: 6px; font-size: 12px; color: var(--muted); }
      .helper-text { margin: 0; color: var(--muted); }
      .callout { border-left: 4px solid var(--accent); background: var(--card); padding: 10px 12px; border-radius: 6px; margin: 10px 0 12px; color: var(--text); }
      .upload-hint { font-size: 14px; font-weight: 600; color: var(--text); margin: 0 0 6px; }
      .assignment-meta { margin-top: 18px; }
      .folder-header { display: flex; align-items: center; justify-content: space-between; gap: 12px; margin: 16px 0 8px; }
      .folder-header h3 { margin: 0; }
      .folder-actions { display: inline-flex; align-items: center; gap: 8px; }
      .archived-title { margin: 0 0 12px; }
      .archived-header { display: flex; align-items: center; justify-content: space-between; gap: 12px; margin: 0 0 12px; }
      .folder-view-banner { display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 12px; }
      .folder-view-banner .helper-text { margin: 0; }
      .folder-open-link { padding: 4px 10px; font-size: 12px; background: var(--secondary); }
      .folder-count { font-size: 12px; color: var(--muted); border: 1px solid var(--border); border-radius: 999px; padding: 2px 10px; background: var(--file-bg); }
      .folder-rename-form { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; margin: 8px 0 12px; }
      .folder-rename-form label { margin: 0; font-weight: 600; }
      .folder-rename-form input[type="text"] { max-width: 280px; }
      .folder-rename-form button { margin-top: 0; }
      .folder-delete-form { display: flex; flex-direction: column; gap: 8px; margin: 8px 0 12px; }
      .folder-delete-form label { font-weight: 600; }
      .folder-delete-options { display: flex; flex-wrap: wrap; gap: 12px; }
      .folder-delete-options label { font-weight: 400; }
      .folder-reorder-form { display: inline-flex; align-items: center; gap: 6px; }
      .folder-reorder { margin-top: 0; padding: 4px 8px; line-height: 1; }
      .folder-empty { margin: 0 0 12px; padding: 10px 12px; border: 1px dashed var(--border); border-radius: 6px; background: var(--file-bg); color: var(--muted); }
      .folder-group.drag-over { outline: 2px dashed var(--accent); outline-offset: 6px; background: var(--file-hover-bg); }
      .drag-cell { width: 80px; }
      .drag-handle { display: inline-flex; align-items: center; justify-content: center; gap: 6px; padding: 4px 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--file-bg); color: var(--text); font-size: 12px; font-weight: 600; cursor: grab; user-select: none; }
      .drag-icon { font-size: 16px; line-height: 1; }
      .drag-handle:active { cursor: grabbing; }
      tr.dragging { opacity: 0.6; }
      table { width: 100%; border-collapse: collapse; }
      th, td { text-align: left; padding: 8px; border-bottom: 1px solid var(--table-border); }
      .flash { background: var(--flash-bg); padding: 10px; border: 1px solid var(--flash-border); border-radius: 4px; margin-bottom: 16px; color: var(--text); }
      .status { font-weight: bold; }
      .status.DRAFT { color: var(--status-draft); }
      .status.APPROVED { color: var(--status-approved); }
      .status.ARCHIVED { color: var(--status-archived); }
      .status.GENERATING { color: var(--status-generating); }
      .status.ERROR { color: var(--status-error); }
      .status.CANCELLED { color: var(--status-cancelled); }
      .status.SUCCESS { color: var(--status-success); }
      .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 10px; }
      .thumb img { max-width: 100%; height: auto; border: 1px solid var(--border); border-radius: 4px; }
      .hidden { display: none; }
      pre { white-space: pre-wrap; background: var(--pre-bg); padding: 10px; border-radius: 4px; color: var(--text); }
      a { color: var(--link); }
      .markdown { line-height: 1.6; max-width: 1040px; }
      .assignment-text { margin-bottom: 26px; }
      .section-divider { height: 1px; width: 100%; max-width: 1040px; background: var(--border); margin: 0 0 18px; }
      .markdown h1, .markdown h2, .markdown h3, .markdown h4 { margin-top: 18px; }
      .markdown table { width: 100%; border-collapse: collapse; margin: 12px 0; }
      .markdown th, .markdown td { border: 1px solid var(--table-border); padding: 6px 8px; }
      .guide-structured { border: 1px solid var(--border); border-radius: 8px; padding: 12px; background: var(--card); }
      .guide-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
      .guide-table th, .guide-table td { border-bottom: 1px solid var(--table-border); padding: 6px 8px; vertical-align: top; }
      .guide-list { margin: 6px 0 0 18px; }
      .guide-part { margin-top: 12px; }
      .upload-form-inner { max-width: 100%; margin: 0 3px 0 0; padding-right: 3px; }
      .upload-form-inner input[type="text"],
      .upload-form-inner textarea,
      .upload-form-inner select,
      .upload-form-inner .file-input,
      .upload-form-inner .dropzone { max-width: 100%; }
      .back-to-top {
        position: fixed;
        right: 22px;
        bottom: 22px;
        width: 46px;
        height: 46px;
        border-radius: 999px;
        border: none;
        background: var(--accent);
        color: #fff;
        font-size: 18px;
        font-weight: 700;
        display: none;
        align-items: center;
        justify-content: center;
        box-shadow: 0 8px 18px rgba(0, 0, 0, 0.18);
        cursor: pointer;
        z-index: 20;
        transition: transform 0.15s ease, box-shadow 0.15s ease, opacity 0.15s ease;
      }
      .back-to-top:hover { transform: translateY(-2px); box-shadow: 0 12px 22px rgba(0, 0, 0, 0.2); }
    </style>
  </head>
  <body>
    <header>
      <a class="logo" href="{{ url_for('index') }}">
        <img src="{{ url_for('static', filename='images/sage.png') }}" alt="" aria-hidden="true" />
        <span>SAGE</span>
      </a>
      <div class="nav-buttons">
        <a class="icon-link" href="{{ url_for('settings') }}" aria-label="Settings">
          <img src="{{ url_for('static', filename='images/settings.png') }}" alt="" aria-hidden="true" />
        </a>
        <button id="locale-toggle" class="icon-link" type="button" aria-label="Language">
          <img id="locale-flag" src="{{ url_for('static', filename='images/flag-us.png') }}" alt="" aria-hidden="true" />
        </button>
        <button id="theme-toggle" class="theme-toggle" type="button" aria-label="Toggle theme">
          <img id="theme-icon" src="{{ url_for('static', filename='images/sun.png') }}" alt="" aria-hidden="true" />
          <span class="sr-only">Toggle theme</span>
        </button>
        <button id="back-button" class="back-button" type="button">{{ t('nav_back') }}</button>
        <a class="home-button" href="{{ url_for('list_assignments') }}">{{ t('nav_home') }}</a>
      </div>
    </header>
    <main>
      {% with messages = get_flashed_messages() %}
        {% if messages %}
          {% for message in messages %}
            <div class="flash">{{ message }}</div>
          {% endfor %}
        {% endif %}
      {% endwith %}
      {% block content %}{% endblock %}
    </main>
    <button id="back-to-top" class="back-to-top" type="button" aria-label="{{ t('back_to_top') }}">
      &uarr;<span class="sr-only">{{ t('back_to_top') }}</span>
    </button>
    <script>
      window.MathJax = {
        tex: {
          inlineMath: [["$", "$"], ["\\(", "\\)"]],
          displayMath: [["$$", "$$"], ["\\[", "\\]"]]
        },
        options: {
          skipHtmlTags: ["script", "noscript", "style", "textarea", "pre", "code"]
        }
      };
    </script>
    <script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
    <script>
      (function () {
        var root = document.documentElement;
        var button = document.getElementById("theme-toggle");
        if (!button) {
          return;
        }
        var sunIcon = "{{ url_for('static', filename='images/sun.png') }}";
        var moonIcon = "{{ url_for('static', filename='images/moon.png') }}";
        var iconEl = document.getElementById("theme-icon");
        function applyTheme(theme) {
          if (theme) {
            root.setAttribute("data-theme", theme);
          } else {
            root.removeAttribute("data-theme");
          }
          if (iconEl) {
            iconEl.src = theme === "dark" ? moonIcon : sunIcon;
          }
        }
        var stored = localStorage.getItem("sage-theme");
        if (stored === "light" || stored === "dark") {
          applyTheme(stored);
        } else {
          var prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
          applyTheme(prefersDark ? "dark" : "light");
        }
        button.addEventListener("click", function () {
          var current = root.getAttribute("data-theme");
          var next = current === "dark" ? "light" : "dark";
          applyTheme(next);
          localStorage.setItem("sage-theme", next);
        });
      })();
    </script>
    <script>
      (function () {
        var localeToggle = document.getElementById("locale-toggle");
        var flagIcon = document.getElementById("locale-flag");
        var flagUs = "{{ url_for('static', filename='images/flag-us.png') }}";
        var flagCz = "{{ url_for('static', filename='images/flag-cz.png') }}";
        var rateCzk = 23.0;
        function getCookie(name) {
          return document.cookie.split(";").map(function (c) { return c.trim(); }).filter(function (c) { return c.indexOf(name + "=") === 0; }).map(function (c) { return c.split("=").slice(1).join("="); })[0];
        }
        function setCookie(name, value) {
          document.cookie = name + "=" + value + "; path=/; max-age=31536000";
        }
        function formatPrice(usdValue, currency) {
          if (currency === "CZK") {
            return (usdValue * rateCzk).toFixed(2) + " Kƒç";
          }
          return "$" + usdValue.toFixed(4);
        }
        function applyLocale(locale) {
          var currency = locale === "cs" ? "CZK" : "USD";
          if (flagIcon) {
            flagIcon.src = locale === "cs" ? flagCz : flagUs;
          }
          var nodes = document.querySelectorAll(".price-amount");
          nodes.forEach(function (node) {
            var raw = node.getAttribute("data-usd");
            var usdValue = parseFloat(raw || "");
            if (Number.isNaN(usdValue)) {
              return;
            }
            node.textContent = formatPrice(usdValue, currency);
          });
        }
        var stored = getCookie("sage_locale") || localStorage.getItem("sage-locale") || "en";
        if (stored !== "cs" && stored !== "en") {
          stored = "en";
        }
        setCookie("sage_locale", stored);
        applyLocale(stored);
        if (localeToggle) {
          localeToggle.addEventListener("click", function () {
            stored = stored === "cs" ? "en" : "cs";
            localStorage.setItem("sage-locale", stored);
            setCookie("sage_locale", stored);
            applyLocale(stored);
            window.location.reload();
          });
        }
      })();
    </script>
    <script>
      (function () {
        var backToTop = document.getElementById("back-to-top");
        if (!backToTop) {
          return;
        }
        function toggleBackToTop() {
          var shouldShow = window.scrollY > 300;
          backToTop.style.display = shouldShow ? "flex" : "none";
        }
        backToTop.addEventListener("click", function () {
          window.scrollTo({ top: 0, behavior: "smooth" });
        });
        window.addEventListener("scroll", toggleBackToTop);
        toggleBackToTop();
      })();
    </script>
    <script>
      (function () {
        var button = document.getElementById("back-button");
        if (!button) {
          return;
        }
        var storageKey = "sage-nav-history";
        var overrideKey = "sage-nav-override-index";
        var maxEntries = 40;
        var current = window.location.pathname + window.location.search + window.location.hash;
        function loadState() {
          try {
            var raw = sessionStorage.getItem(storageKey);
            if (!raw) {
              return { paths: [], index: -1 };
            }
            var parsed = JSON.parse(raw);
            if (!parsed || !Array.isArray(parsed.paths)) {
              return { paths: [], index: -1 };
            }
            if (typeof parsed.index !== "number") {
              parsed.index = parsed.paths.length - 1;
            }
            return parsed;
          } catch (error) {
            return { paths: [], index: -1 };
          }
        }
        function saveState(state) {
          sessionStorage.setItem(storageKey, JSON.stringify(state));
        }
        var state = loadState();
        var override = sessionStorage.getItem(overrideKey);
        if (override !== null) {
          var index = parseInt(override, 10);
          if (!Number.isNaN(index)) {
            state.index = index;
          }
          sessionStorage.removeItem(overrideKey);
        } else {
          if (
            state.index < 0 ||
            state.index >= state.paths.length ||
            state.paths[state.index] !== current
          ) {
            if (state.index < state.paths.length - 1) {
              state.paths = state.paths.slice(0, state.index + 1);
            }
            if (!state.paths.length || state.paths[state.paths.length - 1] !== current) {
              state.paths.push(current);
            }
            state.index = state.paths.length - 1;
            if (state.paths.length > maxEntries) {
              var overflow = state.paths.length - maxEntries;
              state.paths = state.paths.slice(overflow);
              state.index = Math.max(0, state.index - overflow);
            }
          }
        }
        saveState(state);
        button.addEventListener("click", function () {
          var state = loadState();
          if (state.index > 0) {
            var targetIndex = state.index - 1;
            sessionStorage.setItem(overrideKey, String(targetIndex));
            window.location.href = state.paths[targetIndex];
            return;
          }
          if (window.history.length > 1) {
            window.history.back();
            return;
          }
          window.location.href = "{{ url_for('list_assignments') }}";
        });
      })();
    </script>
  </body>
</html>
