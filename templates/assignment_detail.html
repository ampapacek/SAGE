{% extends "base.html" %}

{% block content %}
{% if has_active_jobs or has_pending_rubrics %}
    <script>
      (function () {
        var statusUrl = "{{ url_for('assignment_status', assignment_id=assignment.id) }}";
        var intervalId = setInterval(function () {
          fetch(statusUrl)
            .then(function (response) { return response.json(); })
            .then(function (data) {
              if (!data.has_active_jobs && !data.has_pending_rubrics) {
                clearInterval(intervalId);
                window.location.reload();
              }
            })
            .catch(function () {});
        }, 4000);
      })();
    </script>
  {% endif %}
  <div class="card">
    <h2>{{ assignment.title }}</h2>
    <div class="markdown assignment-text">{{ assignment_html | safe }}</div>
    <div class="section-divider"></div>
    <p class="assignment-meta">
      {{ t('total_price_estimate') }}
      {% if total_price_estimate is not none %}
        <span class="price-amount" data-usd="{{ "%.6f"|format(total_price_estimate) }}">
          ${{ "%.4f"|format(total_price_estimate) }}
        </span>
      {% else %}
        --
      {% endif %}
    </p>
    <a class="action-link" href="{{ url_for('edit_assignment', assignment_id=assignment.id) }}">{{ t('edit_assignment') }}</a>
    <form method="post" action="{{ url_for('delete_assignment', assignment_id=assignment.id) }}" onsubmit="return confirm('Delete this assignment and all related data?');">
      <button type="submit" class="danger">{{ t('delete_assignment') }}</button>
    </form>
  </div>

  <div class="card">
    <h3>{{ t('grading_guides') }}</h3>
    {% if rubrics %}
      <table>
        <thead>
          <tr>
            <th>{{ t('guide_number') }}</th>
            <th>{{ t('status') }}</th>
            <th>{{ t('created') }}</th>
            <th>{{ t('model') }}</th>
            <th>{{ t('duration_s') }}</th>
            <th>{{ t('price') }}</th>
            <th>{{ t('preview') }}</th>
            <th>{{ t('actions') }}</th>
          </tr>
        </thead>
        <tbody>
          {% for rubric in rubrics %}
            <tr>
              <td>{{ rubric.id }}</td>
              <td class="status {{ rubric.status }}">{{ rubric.status }}</td>
              <td>{{ rubric.created_at.strftime('%b %d, %Y %H:%M') }}</td>
              <td>{{ rubric.llm_model or 'manual' }}</td>
              <td>
                {% if rubric.status == 'GENERATING' and rubric.created_at %}
                  <span class="duration-live" data-start="{{ rubric.created_at.isoformat() }}">
                    {{ "%.2f"|format(rubric.duration_seconds or 0) }}
                  </span>
                {% elif rubric.duration_seconds is not none %}
                  {{ "%.2f"|format(rubric.duration_seconds) }}
                {% else %}
                  --
                {% endif %}
              </td>
              <td>
                {% if rubric.price_estimate is not none %}
                  <span class="price-amount" data-usd="{{ "%.6f"|format(rubric.price_estimate) }}">
                    ${{ "%.4f"|format(rubric.price_estimate) }}
                  </span>
                {% else %}
                  --
                {% endif %}
              </td>
              <td>
                {% set words = rubric.rubric_text.split() %}
                {% if words %}
                  {{ words[:5]|join(' ') }}{% if words|length > 5 %}...{% endif %}
                {% else %}
                  --
                {% endif %}
              </td>
              <td>
                <a class="action-link" href="{{ url_for('rubric_detail', rubric_id=rubric.id) }}">{{ t('view') }}</a>
                {% if rubric.status == 'DRAFT' %}
                  <a class="action-link" href="{{ url_for('edit_rubric', rubric_id=rubric.id) }}">{{ t('edit') }}</a>
                {% endif %}
                {% if rubric.status == 'DRAFT' %}
                  <form method="post" action="{{ url_for('approve_rubric', rubric_id=rubric.id) }}">
                    <button type="submit" class="secondary">{{ t('approve_guide') }}</button>
                  </form>
                {% elif rubric.status == 'GENERATING' %}
                  <form method="post" action="{{ url_for('cancel_rubric', rubric_id=rubric.id) }}">
                    <button type="submit" class="secondary">{{ t('cancel') }}</button>
                  </form>
                {% endif %}
                <form method="post" action="{{ url_for('delete_rubric', rubric_id=rubric.id) }}" onsubmit="return confirm('Delete this grading guide and related results?');">
                  <button type="submit" class="danger">{{ t('delete_guide') }}</button>
                </form>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p>{{ t('no_guides') }}</p>
    {% endif %}

    <h4>{{ t('guide_creation') }}</h4>
    <button type="button" class="secondary" onclick="document.getElementById('rubric-forms').classList.toggle('hidden')">
      {{ t('toggle_guide_form') }}
    </button>
    <div id="rubric-forms" {% if approved_rubric %}class="hidden"{% endif %}>
      <h4>{{ t('create_guide_manual') }}</h4>
      <form method="post" action="{{ url_for('create_rubric', assignment_id=assignment.id) }}">
        <label for="rubric_text">{{ t('guide_text') }}</label>
        <textarea id="rubric_text" name="rubric_text" required></textarea>
        <label for="reference_solution_text">{{ t('reference_solution') }}</label>
        <textarea id="reference_solution_text" name="reference_solution_text" required></textarea>
        <button type="submit">{{ t('save_draft') }}</button>
      </form>

      <h4>{{ t('generate_draft_guide') }}</h4>
      <form method="post" action="{{ url_for('generate_rubric', assignment_id=assignment.id) }}">
        <label for="rubric_model">{{ t('choose_model_generation') }}</label>
        <select id="rubric_model" name="llm_model">
          {% set selected_model = default_model %}
          <option value="gpt-4o-mini" data-supports-images="true" {% if selected_model == 'gpt-4o-mini' %}selected{% endif %}>gpt-4o-mini</option>
          <option value="gpt-5-mini" data-supports-images="true" {% if selected_model == 'gpt-5-mini' %}selected{% endif %}>gpt-5-mini</option>
          <option value="gpt-4o" data-supports-images="true" {% if selected_model == 'gpt-4o' %}selected{% endif %}>gpt-4o</option>
          <option value="gpt-4.1" data-supports-images="true" {% if selected_model == 'gpt-4.1' %}selected{% endif %}>gpt-4.1</option>
          <option value="gpt-4.1-mini" data-supports-images="true" {% if selected_model == 'gpt-4.1-mini' %}selected{% endif %}>gpt-4.1-mini</option>
          <option value="o4-mini" data-supports-images="true" {% if selected_model == 'o4-mini' %}selected{% endif %}>o4-mini</option>
          <option value="o3-mini" data-supports-images="false" {% if selected_model == 'o3-mini' %}selected{% endif %}>o3-mini</option>
          <option value="gpt-5" data-supports-images="true" {% if selected_model == 'gpt-5' %}selected{% endif %}>gpt-5</option>
          <option value="gpt-5-nano" data-supports-images="true" {% if selected_model == 'gpt-5-nano' %}selected{% endif %}>gpt-5-nano</option>
        </select>
        <button type="submit">{{ t('generate_draft_llm') }}</button>
      </form>
    </div>
  </div>

  <div class="card">
    <h3>{{ t('upload_submissions') }}</h3>
    <button type="button" class="secondary" onclick="document.getElementById('upload-form').classList.toggle('hidden')">
      {{ t('toggle_uploads') }}
    </button>
    <div id="upload-form">
    {% if not approved_rubric %}
      <p><strong>{{ t('approve_guide_enable') }}</strong></p>
    {% endif %}
    <form method="post" action="{{ url_for('upload_submission', assignment_id=assignment.id) }}" enctype="multipart/form-data">
      <fieldset {% if not approved_rubric %}disabled{% endif %}>
      <label for="student_identifier">{{ t('student_identifier') }}</label>
      <input type="text" id="student_identifier" name="student_identifier" />
      <label for="llm_model">{{ t('model_optional') }}</label>
      <select id="llm_model" name="llm_model">
        {% set selected_model = default_model %}
        <option value="gpt-4o-mini" data-supports-images="true" {% if selected_model == 'gpt-4o-mini' %}selected{% endif %}>gpt-4o-mini</option>
        <option value="gpt-5-mini" data-supports-images="true" {% if selected_model == 'gpt-5-mini' %}selected{% endif %}>gpt-5-mini</option>
        <option value="gpt-4o" data-supports-images="true" {% if selected_model == 'gpt-4o' %}selected{% endif %}>gpt-4o</option>
        <option value="gpt-4.1" data-supports-images="true" {% if selected_model == 'gpt-4.1' %}selected{% endif %}>gpt-4.1</option>
        <option value="gpt-4.1-mini" data-supports-images="true" {% if selected_model == 'gpt-4.1-mini' %}selected{% endif %}>gpt-4.1-mini</option>
        <option value="o4-mini" data-supports-images="true" {% if selected_model == 'o4-mini' %}selected{% endif %}>o4-mini</option>
        <option value="o3-mini" data-supports-images="false" {% if selected_model == 'o3-mini' %}selected{% endif %}>o3-mini</option>
        <option value="gpt-5" data-supports-images="true" {% if selected_model == 'gpt-5' %}selected{% endif %}>gpt-5</option>
        <option value="gpt-5-nano" data-supports-images="true" {% if selected_model == 'gpt-5-nano' %}selected{% endif %}>gpt-5-nano</option>
      </select>
      <label for="submitted_text">{{ t('submitted_text_optional') }}</label>
      <textarea id="submitted_text" name="submitted_text"></textarea>
      <div class="dropzone" id="files-drop">
        <label for="files">{{ t('files_label') }}</label>
        <input type="file" id="files" name="files" multiple class="file-input" />
        <div class="dropzone-hint">{{ t('drop_files_hint') }}</div>
      </div>
      <div class="dropzone" id="zip-drop">
        <label for="zip_file">{{ t('zip_label') }}</label>
        <input type="file" id="zip_file" name="zip_file" accept=".zip" class="file-input" />
        <div class="dropzone-hint">{{ t('drop_zip_hint') }}</div>
      </div>
      <button type="submit">{{ t('upload') }}</button>
      </fieldset>
    </form>
    </div>
    <script>
      (function () {
        var fileInput = document.getElementById("files");
        var zipInput = document.getElementById("zip_file");
        var modelSelect = document.getElementById("llm_model");
        var filesDrop = document.getElementById("files-drop");
        var zipDrop = document.getElementById("zip-drop");
        if (!fileInput || !zipInput || !modelSelect) {
          return;
        }
        function setupDropZone(zone, input, filterFn) {
          if (!zone || !input) {
            return;
          }
          function setActive(active) {
            if (active) {
              zone.classList.add("active");
            } else {
              zone.classList.remove("active");
            }
          }
          zone.addEventListener("dragenter", function (event) {
            event.preventDefault();
            setActive(true);
          });
          zone.addEventListener("dragover", function (event) {
            event.preventDefault();
            setActive(true);
          });
          zone.addEventListener("dragleave", function () {
            setActive(false);
          });
          zone.addEventListener("drop", function (event) {
            event.preventDefault();
            setActive(false);
            var files = Array.prototype.slice.call(event.dataTransfer.files || []);
            if (filterFn) {
              files = files.filter(filterFn);
            }
            if (!files.length) {
              return;
            }
            var dataTransfer = new DataTransfer();
            files.forEach(function (file) {
              dataTransfer.items.add(file);
            });
            input.files = dataTransfer.files;
            input.dispatchEvent(new Event("change"));
          });
        }
        setupDropZone(filesDrop, fileInput, null);
        setupDropZone(zipDrop, zipInput, function (file) {
          return (file.name || "").toLowerCase().endsWith(".zip");
        });
        function optionSupportsImages(option) {
          return option.dataset.supportsImages !== "false";
        }
        function requiresImages() {
          if (zipInput.files && zipInput.files.length) {
            return true;
          }
          if (!fileInput.files) {
            return false;
          }
          for (var i = 0; i < fileInput.files.length; i++) {
            var name = (fileInput.files[i].name || "").toLowerCase();
            if (
              name.endsWith(".pdf") ||
              name.endsWith(".png") ||
              name.endsWith(".jpg") ||
              name.endsWith(".jpeg")
            ) {
              return true;
            }
          }
          return false;
        }
        function updateModelOptions() {
          var needsImages = requiresImages();
          var options = modelSelect.options;
          var firstEnabled = null;
          for (var i = 0; i < options.length; i++) {
            var option = options[i];
            var disabled = needsImages && !optionSupportsImages(option);
            option.disabled = disabled;
            if (!disabled && firstEnabled === null) {
              firstEnabled = option.value;
            }
          }
          if (
            needsImages &&
            modelSelect.selectedOptions.length &&
            modelSelect.selectedOptions[0].disabled &&
            firstEnabled !== null
          ) {
            modelSelect.value = firstEnabled;
          }
        }
        fileInput.addEventListener("change", updateModelOptions);
        zipInput.addEventListener("change", updateModelOptions);
      })();
    </script>
  </div>

  <div class="card">
    <h3>{{ t('submissions') }}</h3>
    {% if submissions %}
      <table>
        <thead>
          <tr>
            <th>{{ t('student') }}</th>
            <th>{{ t('created') }}</th>
            <th>{{ t('grade') }}</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for submission in submissions %}
            <tr>
              <td>{{ submission.student_identifier }}</td>
              <td>{{ submission.created_at.strftime('%b %d, %Y %H:%M') }}</td>
              <td>
                {{ submission.grade_display }}
              </td>
              <td><a class="action-link" href="{{ url_for('submission_detail', submission_id=submission.id) }}">{{ t('open') }}</a></td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      <p><a href="{{ url_for('export_csv', assignment_id=assignment.id) }}">{{ t('export_csv') }}</a></p>
    {% else %}
      <p>{{ t('no_submissions') }}</p>
    {% endif %}
  </div>

  <div class="card">
    <h3>{{ t('jobs') }}</h3>
    {% if jobs %}
      <table>
        <thead>
          <tr>
            <th>{{ t('status') }}</th>
            <th>{{ t('created') }}</th>
            <th>{{ t('submission_number') }}</th>
            <th>{{ t('student') }}</th>
            <th>{{ t('model') }}</th>
            <th>{{ t('duration_s') }}</th>
            <th>{{ t('price') }}</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for job in jobs %}
            <tr>
              <td class="status {{ job.status }}">{{ job.status }}</td>
              <td>{{ job.created_at.strftime('%b %d, %Y %H:%M') }}</td>
              <td>{{ job.submission_id }}</td>
              <td>{{ job.submission.student_identifier if job.submission else 'unknown' }}</td>
              <td>{{ job.llm_model or 'unknown' }}</td>
              <td>
                {% if job.status == 'RUNNING' and job.started_at %}
                  <span class="duration-live" data-start="{{ job.started_at.isoformat() }}">
                    {{ "%.2f"|format(job.duration_seconds or 0) }}
                  </span>
                {% elif job.duration_seconds is not none %}
                  {{ "%.2f"|format(job.duration_seconds) }}
                {% else %}
                  --
                {% endif %}
              </td>
              <td>
                {% if job.price_estimate_display is not none %}
                  <span class="price-amount" data-usd="{{ "%.6f"|format(job.price_estimate_display) }}">
                    ${{ "%.4f"|format(job.price_estimate_display) }}
                  </span>
                {% else %}
                  --
                {% endif %}
              </td>
              <td>
                <a class="action-link" href="{{ url_for('job_detail', job_id=job.id) }}">{{ t('view') }}</a>
                {% if job.status in ['QUEUED', 'RUNNING'] %}
                  <form method="post" action="{{ url_for('terminate_job', job_id=job.id) }}">
                    <button type="submit" class="secondary">{{ t('terminate_job') }}</button>
                  </form>
                {% else %}
                  <form method="post" action="{{ url_for('delete_job', job_id=job.id) }}" onsubmit="return confirm('Delete this job?');">
                    <button type="submit" class="danger">{{ t('delete_job') }}</button>
                  </form>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p>{{ t('no_jobs') }}</p>
    {% endif %}
  </div>

  <script>
    (function () {
      function parseStart(value) {
        if (!value) {
          return null;
        }
        var hasTimezone = /Z$|[+-]\d{2}:?\d{2}$/.test(value);
        var normalized = hasTimezone ? value : value + "Z";
        var date = new Date(normalized);
        if (Number.isNaN(date.getTime())) {
          return null;
        }
        return date;
      }
      function updateDurations() {
        var nodes = document.querySelectorAll(".duration-live");
        if (!nodes.length) {
          return;
        }
        var now = Date.now();
        nodes.forEach(function (node) {
          var startValue = node.getAttribute("data-start");
          var start = parseStart(startValue);
          if (!start) {
            return;
          }
          var seconds = (now - start.getTime()) / 1000;
          if (seconds < 0) {
            seconds = 0;
          }
          node.textContent = seconds.toFixed(2);
        });
      }
      updateDurations();
      setInterval(updateDurations, 1000);
    })();
  </script>
{% endblock %}
