{% extends "base.html" %}

{% block content %}
{% if has_active_jobs or has_pending_rubrics %}
    <script>
      (function () {
        var statusUrl = "{{ url_for('assignment_status', assignment_id=assignment.id) }}";
        var intervalId = setInterval(function () {
          fetch(statusUrl)
            .then(function (response) { return response.json(); })
            .then(function (data) {
              if (!data.has_active_jobs && !data.has_pending_rubrics) {
                clearInterval(intervalId);
                window.location.reload();
              }
            })
            .catch(function () {});
        }, 4000);
      })();
    </script>
  {% endif %}
  <div class="card">
    <h2>{{ assignment.title }}</h2>
    <div class="markdown assignment-text">{{ assignment_html | safe }}</div>
    <div class="section-divider"></div>
    <p class="assignment-meta">
      {{ t('total_price_estimate') }}
      {% if total_price_estimate is not none %}
        <span class="price-amount" data-usd="{{ "%.6f"|format(total_price_estimate) }}">
          ${{ "%.4f"|format(total_price_estimate) }}
        </span>
      {% else %}
        --
      {% endif %}
    </p>
    <a class="action-link" href="{{ url_for('edit_assignment', assignment_id=assignment.id) }}">{{ t('edit_assignment') }}</a>
    <form method="post" action="{{ url_for('delete_assignment', assignment_id=assignment.id) }}" onsubmit="return confirm('Delete this assignment and all related data?');">
      <button type="submit" class="danger">{{ t('delete_assignment') }}</button>
    </form>
  </div>

  <div class="card">
    <h3>{{ t('grading_guides') }}</h3>
    {% if rubrics %}
      <table>
        <thead>
          <tr>
            <th>{{ t('guide_number') }}</th>
            <th>{{ t('status') }}</th>
            <th>{{ t('provider') }}</th>
            <th>{{ t('created') }}</th>
            <th>{{ t('model') }}</th>
            <th>{{ t('duration_s') }}</th>
            <th>{{ t('price') }}</th>
            <th>{{ t('preview') }}</th>
            <th>{{ t('actions') }}</th>
          </tr>
        </thead>
        <tbody>
          {% for rubric in rubrics %}
            <tr>
              <td>{{ rubric.id }}</td>
              <td class="status {{ rubric.status }}">{{ rubric.status }}</td>
              <td>{{ rubric.provider_display }}</td>
              <td>{{ rubric.created_at.strftime('%b %d, %Y %H:%M') }}</td>
              <td>{{ rubric.llm_model or 'manual' }}</td>
              <td>
                {% if rubric.status == 'GENERATING' and rubric.created_at %}
                  <span class="duration-live" data-start="{{ rubric.created_at.isoformat() }}">
                    {{ "%.2f"|format(rubric.duration_seconds or 0) }}
                  </span>
                {% elif rubric.duration_seconds is not none %}
                  {{ "%.2f"|format(rubric.duration_seconds) }}
                {% else %}
                  --
                {% endif %}
              </td>
              <td>
                {% if rubric.price_estimate is not none %}
                  <span class="price-amount" data-usd="{{ "%.6f"|format(rubric.price_estimate) }}">
                    ${{ "%.4f"|format(rubric.price_estimate) }}
                  </span>
                {% else %}
                  --
                {% endif %}
              </td>
              <td>
                {% set words = rubric.rubric_text.split() %}
                {% if words %}
                  {{ words[:5]|join(' ') }}{% if words|length > 5 %}...{% endif %}
                {% else %}
                  --
                {% endif %}
              </td>
              <td>
                <a class="action-link" href="{{ url_for('rubric_detail', rubric_id=rubric.id) }}">{{ t('view') }}</a>
                {% if rubric.status == 'DRAFT' %}
                  <a class="action-link" href="{{ url_for('edit_rubric', rubric_id=rubric.id) }}">{{ t('edit') }}</a>
                {% endif %}
                {% if rubric.status == 'DRAFT' %}
                  <form method="post" action="{{ url_for('approve_rubric', rubric_id=rubric.id) }}">
                    <button type="submit" class="secondary">{{ t('approve_guide') }}</button>
                  </form>
                {% elif rubric.status == 'GENERATING' %}
                  <form method="post" action="{{ url_for('cancel_rubric', rubric_id=rubric.id) }}">
                    <button type="submit" class="secondary">{{ t('cancel') }}</button>
                  </form>
                {% endif %}
                <form method="post" action="{{ url_for('delete_rubric', rubric_id=rubric.id) }}" onsubmit="return confirm('Delete this grading guide and related results?');">
                  <button type="submit" class="danger">{{ t('delete_guide') }}</button>
                </form>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p>{{ t('no_guides') }}</p>
    {% endif %}

    <h4>{{ t('guide_creation') }}</h4>
    <button type="button" class="secondary" onclick="document.getElementById('rubric-forms').classList.toggle('hidden')">
      {{ t('toggle_guide_form') }}
    </button>
    <div id="rubric-forms" {% if approved_rubric %}class="hidden"{% endif %}>
      <h4>{{ t('create_guide_manual') }}</h4>
      <form method="post" action="{{ url_for('create_rubric', assignment_id=assignment.id) }}">
        <label for="rubric_text">{{ t('guide_text') }}</label>
        <textarea id="rubric_text" name="rubric_text" required></textarea>
        <label for="reference_solution_text">{{ t('reference_solution') }}</label>
        <textarea id="reference_solution_text" name="reference_solution_text" required></textarea>
        <button type="submit">{{ t('save_draft') }}</button>
      </form>

      <h4>{{ t('generate_draft_guide') }}</h4>
      <form method="post" action="{{ url_for('generate_rubric', assignment_id=assignment.id) }}">
        <label for="rubric_provider">{{ t('provider_label') }}</label>
        <select id="rubric_provider" name="llm_provider">
          {% set rubric_selected_provider = default_provider %}
          {% for option in provider_options %}
            <option value="{{ option.value }}" {% if rubric_selected_provider == option.value %}selected{% endif %}>{{ option.label }}</option>
          {% endfor %}
        </select>
        <label for="rubric_model">{{ t('choose_model_generation') }}</label>
        <select id="rubric_model" name="llm_model">
          {% set selected_model = default_model %}
          {% set rubric_model_options = provider_model_options.get(rubric_selected_provider, []) %}
          {% set rubric_model_values = rubric_model_options | map(attribute='value') | list %}
          {% set rubric_is_custom = selected_model and selected_model not in rubric_model_values %}
          {% for option in rubric_model_options %}
            <option value="{{ option.value }}" {% if option.supports_images is not none and not option.supports_images %}data-supports-images="false"{% endif %} {% if selected_model == option.value %}selected{% endif %}>{{ option.value }}</option>
          {% endfor %}
          <option value="other" {% if rubric_is_custom %}selected{% endif %}>{{ t('other_model_option') }}</option>
        </select>
          <div id="rubric_custom_wrap" {% if not rubric_is_custom %}class="hidden"{% endif %}>
            <label for="rubric_custom_model">{{ t('custom_model_label') }}</label>
            <input
              type="text"
              id="rubric_custom_model"
              name="custom_llm_model"
              value="{% if rubric_is_custom %}{{ selected_model }}{% endif %}"
              placeholder="{{ t('custom_model_placeholder') }}"
            />
          </div>
        <button type="submit">{{ t('generate_draft_llm') }}</button>
      </form>
    </div>
  </div>

  <div class="card">
      <h3>{{ t('upload_submissions') }}</h3>
    <button type="button" class="secondary" onclick="document.getElementById('upload-form').classList.toggle('hidden')">
      {{ t('toggle_uploads') }}
    </button>
    <div id="upload-form">
    {% if not approved_rubric %}
      <p><strong>{{ t('approve_guide_enable') }}</strong></p>
    {% endif %}
    <form method="post" action="{{ url_for('upload_submission', assignment_id=assignment.id) }}" enctype="multipart/form-data">
      <fieldset {% if not approved_rubric %}disabled{% endif %}>
        <div class="upload-form-inner">
          <label for="student_identifier">{{ t('student_identifier') }}</label>
          <input type="text" id="student_identifier" name="student_identifier" />
          <label for="llm_provider">{{ t('provider_label') }}</label>
          <select id="llm_provider" name="llm_provider">
            {% set selected_provider = default_provider %}
            {% for option in provider_options %}
              <option value="{{ option.value }}" {% if selected_provider == option.value %}selected{% endif %}>{{ option.label }}</option>
            {% endfor %}
          </select>
          <label for="llm_model">{{ t('model_selection') }}</label>
          <select id="llm_model" name="llm_model">
            {% set selected_model = default_model %}
            {% set submission_model_options = provider_model_options.get(selected_provider, []) %}
            {% set submission_model_values = submission_model_options | map(attribute='value') | list %}
            {% set submission_is_custom = selected_model and selected_model not in submission_model_values %}
            {% for option in submission_model_options %}
              <option value="{{ option.value }}" {% if option.supports_images is not none and not option.supports_images %}data-supports-images="false"{% endif %} {% if selected_model == option.value %}selected{% endif %}>{{ option.value }}</option>
            {% endfor %}
            <option value="other" {% if submission_is_custom %}selected{% endif %}>{{ t('other_model_option') }}</option>
          </select>
          <div id="custom_model_wrap" {% if not submission_is_custom %}class="hidden"{% endif %}>
            <label for="custom_llm_model">{{ t('custom_model_label') }}</label>
            <input
              type="text"
              id="custom_llm_model"
              name="custom_llm_model"
              value="{% if submission_is_custom %}{{ selected_model }}{% endif %}"
              placeholder="{{ t('custom_model_placeholder') }}"
            />
          </div>
          <label for="submitted_text">{{ t('submitted_text_optional') }}</label>
          <textarea id="submitted_text" name="submitted_text"></textarea>
          <div class="dropzone" id="files-drop">
            <label for="files">{{ t('files_label') }}</label>
            <input type="file" id="files" name="files" multiple class="file-input" />
            <div class="dropzone-hint">{{ t('drop_files_hint') }}</div>
          </div>
          <div class="dropzone" id="zip-drop">
            <label for="zip_file">{{ t('zip_label') }}</label>
            <input type="file" id="zip_file" name="zip_file" accept=".zip" class="file-input" />
            <div class="dropzone-hint">{{ t('drop_zip_hint') }}</div>
          </div>
          <button type="submit">{{ t('upload') }}</button>
        </div>
      </fieldset>
    </form>
    </div>
    <script>
      (function () {
        var fileInput = document.getElementById("files");
        var zipInput = document.getElementById("zip_file");
        var providerSelect = document.getElementById("llm_provider");
        var modelSelect = document.getElementById("llm_model");
        var customModel = document.getElementById("custom_llm_model");
        var customWrap = document.getElementById("custom_model_wrap");
        var rubricProvider = document.getElementById("rubric_provider");
        var rubricModel = document.getElementById("rubric_model");
        var rubricCustomModel = document.getElementById("rubric_custom_model");
        var rubricCustomWrap = document.getElementById("rubric_custom_wrap");
        var filesDrop = document.getElementById("files-drop");
        var zipDrop = document.getElementById("zip-drop");
        var providerModelOptions = {{ provider_model_options | tojson }};
        var otherLabel = "{{ t('other_model_option') }}";
        if (!fileInput || !zipInput || !modelSelect) {
          return;
        }
        function toggleCustomModel(selectEl, wrapEl) {
          if (!selectEl || !wrapEl) {
            return;
          }
          var show = selectEl.value === "other";
          wrapEl.classList.toggle("hidden", !show);
        }
        function setupDropZone(zone, input, filterFn) {
          if (!zone || !input) {
            return;
          }
          function setActive(active) {
            if (active) {
              zone.classList.add("active");
            } else {
              zone.classList.remove("active");
            }
          }
          zone.addEventListener("dragenter", function (event) {
            event.preventDefault();
            setActive(true);
          });
          zone.addEventListener("dragover", function (event) {
            event.preventDefault();
            setActive(true);
          });
          zone.addEventListener("dragleave", function () {
            setActive(false);
          });
          zone.addEventListener("drop", function (event) {
            event.preventDefault();
            setActive(false);
            var files = Array.prototype.slice.call(event.dataTransfer.files || []);
            if (filterFn) {
              files = files.filter(filterFn);
            }
            if (!files.length) {
              return;
            }
            var dataTransfer = new DataTransfer();
            files.forEach(function (file) {
              dataTransfer.items.add(file);
            });
            input.files = dataTransfer.files;
            input.dispatchEvent(new Event("change"));
          });
        }
        setupDropZone(filesDrop, fileInput, null);
        setupDropZone(zipDrop, zipInput, function (file) {
          return (file.name || "").toLowerCase().endsWith(".zip");
        });
        function optionSupportsImages(option) {
          return option.dataset.supportsImages !== "false";
        }
        function requiresImages() {
          if (zipInput.files && zipInput.files.length) {
            return true;
          }
          if (!fileInput.files) {
            return false;
          }
          for (var i = 0; i < fileInput.files.length; i++) {
            var name = (fileInput.files[i].name || "").toLowerCase();
            if (
              name.endsWith(".pdf") ||
              name.endsWith(".png") ||
              name.endsWith(".jpg") ||
              name.endsWith(".jpeg")
            ) {
              return true;
            }
          }
          return false;
        }
        function selectedModelValue(selectEl, customInput) {
          if (!selectEl) {
            return "";
          }
          if (selectEl.value === "other" && customInput && customInput.value.trim()) {
            return customInput.value.trim();
          }
          return selectEl.value || "";
        }
        function rebuildModelOptions(selectEl, providerKey, customInput, selectedValue) {
          if (!selectEl) {
            return;
          }
          var options = providerModelOptions[providerKey] || [];
          selectEl.innerHTML = "";
          options.forEach(function (opt) {
            var option = document.createElement("option");
            option.value = opt.value;
            option.textContent = opt.value;
            if (opt.supports_images === false) {
              option.dataset.supportsImages = "false";
            }
            selectEl.appendChild(option);
          });
          var otherOption = document.createElement("option");
          otherOption.value = "other";
          otherOption.textContent = otherLabel;
          selectEl.appendChild(otherOption);
          var hasMatch = options.some(function (opt) {
            return opt.value === selectedValue;
          });
          if (selectedValue && hasMatch) {
            selectEl.value = selectedValue;
          } else {
            selectEl.value = "other";
          }
          if (customInput) {
            if (selectedValue && !hasMatch) {
              customInput.value = selectedValue;
            } else if (selectEl.value !== "other") {
              customInput.value = "";
            }
          }
        }
        function applyImageConstraints(selectEl) {
          if (!selectEl) {
            return;
          }
          var needsImages = requiresImages();
          var options = selectEl.options;
          var firstEnabled = null;
          for (var i = 0; i < options.length; i++) {
            var option = options[i];
            var disabled = needsImages && !optionSupportsImages(option);
            option.disabled = disabled;
            if (!disabled && firstEnabled === null) {
              firstEnabled = option.value;
            }
          }
          if (
            needsImages &&
            selectEl.selectedOptions.length &&
            selectEl.selectedOptions[0].disabled &&
            firstEnabled !== null
          ) {
            selectEl.value = firstEnabled;
          }
        }
        function refreshModelSelects() {
          if (providerSelect && modelSelect) {
            rebuildModelOptions(
              modelSelect,
              providerSelect.value,
              customModel,
              selectedModelValue(modelSelect, customModel)
            );
            toggleCustomModel(modelSelect, customWrap);
            applyImageConstraints(modelSelect);
          }
          if (rubricProvider && rubricModel) {
            rebuildModelOptions(
              rubricModel,
              rubricProvider.value,
              rubricCustomModel,
              selectedModelValue(rubricModel, rubricCustomModel)
            );
            toggleCustomModel(rubricModel, rubricCustomWrap);
          }
        }
        if (providerSelect) {
          providerSelect.addEventListener("change", refreshModelSelects);
        }
        modelSelect.addEventListener("change", function () {
          toggleCustomModel(modelSelect, customWrap);
          applyImageConstraints(modelSelect);
        });
        if (rubricModel) {
          rubricModel.addEventListener("change", function () {
            toggleCustomModel(rubricModel, rubricCustomWrap);
          });
        }
        if (rubricProvider) {
          rubricProvider.addEventListener("change", refreshModelSelects);
        }
        fileInput.addEventListener("change", function () {
          applyImageConstraints(modelSelect);
        });
        zipInput.addEventListener("change", function () {
          applyImageConstraints(modelSelect);
        });
        refreshModelSelects();
      })();
    </script>
  </div>

  <div class="card">
    <h3>{{ t('submissions') }}</h3>
    {% if submissions %}
      <table>
        <thead>
          <tr>
            <th>{{ t('student') }}</th>
            <th>{{ t('created') }}</th>
            <th>{{ t('grade') }}</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for submission in submissions %}
            <tr>
              <td>{{ submission.student_identifier }}</td>
              <td>{{ submission.created_at.strftime('%b %d, %Y %H:%M') }}</td>
              <td>
                {{ submission.grade_display }}
              </td>
              <td>
                <a class="action-link" href="{{ url_for('submission_detail', submission_id=submission.id) }}">{{ t('open') }}</a>
                <form method="post" action="{{ url_for('delete_submission', submission_id=submission.id) }}" onsubmit="return confirm('{{ t('delete_submission_confirm') }}');">
                  <button type="submit" class="danger">{{ t('delete_submission') }}</button>
                </form>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      <p><a href="{{ url_for('export_csv', assignment_id=assignment.id) }}">{{ t('export_csv') }}</a></p>
    {% else %}
      <p>{{ t('no_submissions') }}</p>
    {% endif %}
  </div>

  <div class="card">
    <h3>{{ t('jobs') }}</h3>
    {% if jobs %}
      <table>
        <thead>
          <tr>
            <th>{{ t('status') }}</th>
            <th>{{ t('created') }}</th>
            <th>{{ t('submission_number') }}</th>
            <th>{{ t('student') }}</th>
            <th>{{ t('provider') }}</th>
            <th>{{ t('model') }}</th>
            <th>{{ t('duration_s') }}</th>
            <th>{{ t('price') }}</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for job in jobs %}
            <tr>
              <td class="status {{ job.status }}">{{ job.status }}</td>
              <td>{{ job.created_at.strftime('%b %d, %Y %H:%M') }}</td>
              <td>{{ job.submission_id }}</td>
              <td>{{ job.submission.student_identifier if job.submission else 'unknown' }}</td>
              <td>{{ job.provider_display }}</td>
              <td>{{ job.llm_model or 'unknown' }}</td>
              <td>
                {% if job.status == 'RUNNING' and job.started_at %}
                  <span class="duration-live" data-start="{{ job.started_at.isoformat() }}">
                    {{ "%.2f"|format(job.duration_seconds or 0) }}
                  </span>
                {% elif job.duration_seconds is not none %}
                  {{ "%.2f"|format(job.duration_seconds) }}
                {% else %}
                  --
                {% endif %}
              </td>
              <td>
                {% if job.price_estimate_display is not none %}
                  <span class="price-amount" data-usd="{{ "%.6f"|format(job.price_estimate_display) }}">
                    ${{ "%.4f"|format(job.price_estimate_display) }}
                  </span>
                {% else %}
                  --
                {% endif %}
              </td>
              <td>
                <a class="action-link" href="{{ url_for('job_detail', job_id=job.id) }}">{{ t('view') }}</a>
                {% if job.status in ['QUEUED', 'RUNNING'] %}
                  <form method="post" action="{{ url_for('terminate_job', job_id=job.id) }}">
                    <button type="submit" class="secondary">{{ t('terminate_job') }}</button>
                  </form>
                {% else %}
                  <form method="post" action="{{ url_for('delete_job', job_id=job.id) }}" onsubmit="return confirm('Delete this job?');">
                    <button type="submit" class="danger">{{ t('delete_job') }}</button>
                  </form>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p>{{ t('no_jobs') }}</p>
    {% endif %}
  </div>

  <script>
    (function () {
      function parseStart(value) {
        if (!value) {
          return null;
        }
        var hasTimezone = /Z$|[+-]\d{2}:?\d{2}$/.test(value);
        var normalized = hasTimezone ? value : value + "Z";
        var date = new Date(normalized);
        if (Number.isNaN(date.getTime())) {
          return null;
        }
        return date;
      }
      function updateDurations() {
        var nodes = document.querySelectorAll(".duration-live");
        if (!nodes.length) {
          return;
        }
        var now = Date.now();
        nodes.forEach(function (node) {
          var startValue = node.getAttribute("data-start");
          var start = parseStart(startValue);
          if (!start) {
            return;
          }
          var seconds = (now - start.getTime()) / 1000;
          if (seconds < 0) {
            seconds = 0;
          }
          node.textContent = seconds.toFixed(2);
        });
      }
      updateDurations();
      setInterval(updateDurations, 1000);
    })();
  </script>
{% endblock %}
