{% extends "base.html" %}

{% block content %}
  <style>
    .lightbox {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
      padding: 20px;
    }
    .lightbox.active { display: flex; }
    .lightbox-inner {
      position: relative;
      max-width: 90vw;
      max-height: 90vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .lightbox img {
      max-width: 90vw;
      max-height: 90vh;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .lightbox-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      border: none;
      background: rgba(255, 255, 255, 0.15);
      color: #fff;
      width: 44px;
      height: 44px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 20px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .lightbox-btn:hover { background: rgba(255, 255, 255, 0.25); }
    .lightbox-prev { left: -60px; }
    .lightbox-next { right: -60px; }
    .lightbox-close {
      position: absolute;
      top: -50px;
      right: 0;
      border: none;
      background: rgba(255, 255, 255, 0.15);
      color: #fff;
      width: 36px;
      height: 36px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 18px;
    }
    .thumb button {
      border: none;
      padding: 0;
      background: transparent;
      cursor: pointer;
    }
    .thumb button:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 4px;
    }
    @media (max-width: 760px) {
      .lightbox-prev { left: 8px; }
      .lightbox-next { right: 8px; }
      .lightbox-close { top: 8px; }
    }
  </style>

  <div class="card">
    <h2>{{ t('submission') }} {{ submission.id }} - {{ submission.student_identifier }}</h2>
    <p>{{ t('assignment') }}: <a href="{{ url_for('assignment_detail', assignment_id=assignment.id) }}">{{ assignment.title }}</a></p>
    <p>{{ t('submitted') }}: {{ submission.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
  </div>

  <div class="card">
    <h3>{{ t('submitted_text') }}</h3>
    {% if student_text %}
      <div class="markdown">{{ student_text_html | safe }}</div>
    {% else %}
      <p>{{ t('no_submitted_text') }}</p>
    {% endif %}
  </div>

  <div class="card">
    <h3>{{ t('files') }}</h3>
    {% if submission.files %}
      <ul>
        {% for file in submission.files %}
          <li><a href="{{ url_for('data_file', filepath=file.file_path) }}">{{ file.original_filename }}</a> ({{ file.file_type }})</li>
        {% endfor %}
      </ul>
    {% else %}
      <p>{{ t('no_files') }}</p>
    {% endif %}
  </div>

  <div class="card">
    <h3>{{ t('guide') }}</h3>
    {% if rubric %}
      <p>
        <a class="action-link" href="{{ url_for('rubric_detail', rubric_id=rubric.id) }}">
          {{ t('view') }}
        </a>
      </p>
      <button
        type="button"
        class="secondary"
        data-toggle-target="submission-guide"
        data-show-label="{{ t('show_guide') }}"
        data-hide-label="{{ t('hide_guide') }}"
      >
        {{ t('show_guide') }}
      </button>
      <div id="submission-guide" class="hidden" style="margin-top: 12px;">
        {% if rubric_structured %}
          <div class="guide-structured">
            {% if rubric_structured.total_points is not none %}
              <p><strong>{{ t('total_points') }}:</strong> {{ rubric_structured.total_points }}</p>
            {% endif %}
            {% set parts = rubric_structured.get('parts') %}
            {% if parts %}
              <table class="guide-table">
                <thead>
                  <tr>
                    <th>{{ t('part_label') }}</th>
                    <th>{{ t('max_points') }}</th>
                    <th>{{ t('criteria') }}</th>
                  </tr>
                </thead>
                <tbody>
                  {% if parts is mapping %}
                    {% for part_id, part in parts.items() %}
                      <tr>
                        <td>{{ part_id }}</td>
                        <td>{{ part.max_points or part.points_possible or part.points or '--' }}</td>
                        <td>
                          {% set criteria = part.criteria %}
                          {% if criteria is sequence and criteria is not string %}
                            <ul class="guide-list">
                              {% for item in criteria %}
                                <li>{{ item }}</li>
                              {% endfor %}
                            </ul>
                          {% elif criteria %}
                            {{ criteria }}
                          {% else %}
                            --
                          {% endif %}
                        </td>
                      </tr>
                    {% endfor %}
                  {% elif parts is sequence and parts is not string %}
                    {% for part in parts %}
                      <tr>
                        <td>{{ part.part_id or loop.index }}</td>
                        <td>{{ part.max_points or part.points_possible or part.points or '--' }}</td>
                        <td>
                          {% set criteria = part.criteria %}
                          {% if criteria is sequence and criteria is not string %}
                            <ul class="guide-list">
                              {% for item in criteria %}
                                <li>{{ item }}</li>
                              {% endfor %}
                            </ul>
                          {% elif criteria %}
                            {{ criteria }}
                          {% else %}
                            --
                          {% endif %}
                        </td>
                      </tr>
                    {% endfor %}
                  {% endif %}
                </tbody>
              </table>
            {% endif %}
          </div>
        {% else %}
          <pre>{{ rubric.rubric_text or 'Not available yet.' }}</pre>
        {% endif %}
      </div>
      <button
        type="button"
        class="secondary"
        data-toggle-target="submission-reference"
        data-show-label="{{ t('show_reference_solution') }}"
        data-hide-label="{{ t('hide_reference_solution') }}"
        style="margin-left: 8px;"
      >
        {{ t('show_reference_solution') }}
      </button>
      <div id="submission-reference" class="hidden" style="margin-top: 12px;">
        {% if reference_structured %}
          <div class="guide-structured">
            {% for part_id, part in reference_structured.items() %}
              <div class="guide-part">
                <h4 style="margin: 0 0 6px;">{{ t('part_label') }} {{ part_id }}</h4>
                {% if part is mapping %}
                  <ul class="guide-list">
                    {% for key, value in part.items() %}
                      <li>
                        <strong>{{ key|replace('_', ' ')|title }}:</strong>
                        {% if value is sequence and value is not string %}
                          {{ value|join(', ') }}
                        {% else %}
                          {{ value }}
                        {% endif %}
                      </li>
                    {% endfor %}
                  </ul>
                {% elif part is sequence and part is not string %}
                  <ul class="guide-list">
                    {% for item in part %}
                      <li>{{ item }}</li>
                    {% endfor %}
                  </ul>
                {% else %}
                  <p style="margin: 0;">{{ part }}</p>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        {% else %}
          <pre>{{ rubric.reference_solution_text or 'Not available yet.' }}</pre>
        {% endif %}
      </div>
    {% else %}
      <p>{{ t('no_guide_available') }}</p>
    {% endif %}
  </div>

  <div class="card">
    <h3>{{ t('images') }}</h3>
    {% if images %}
      <div class="grid">
        {% for path in images %}
          <div class="thumb">
            <button type="button" class="image-thumb" data-index="{{ loop.index0 }}">
              <img src="{{ url_for('data_file', filepath=path) }}" alt="page {{ loop.index }}" />
            </button>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p>{{ t('no_images') }}</p>
    {% endif %}
  </div>

  {% if images %}
    <div class="lightbox" id="lightbox" aria-hidden="true">
      <div class="lightbox-inner">
        <button class="lightbox-btn lightbox-prev" type="button" aria-label="{{ t('previous_image') }}">&lsaquo;</button>
        <img id="lightbox-image" src="" alt="" />
        <button class="lightbox-btn lightbox-next" type="button" aria-label="{{ t('next_image') }}">&rsaquo;</button>
        <button class="lightbox-close" type="button" aria-label="{{ t('close') }}">Ã—</button>
      </div>
    </div>
    <script>
      (function () {
        var images = [
          {% for path in images %}
            "{{ url_for('data_file', filepath=path) }}"{% if not loop.last %},{% endif %}
          {% endfor %}
        ];
        var lightbox = document.getElementById("lightbox");
        var imageEl = document.getElementById("lightbox-image");
        var prevBtn = lightbox.querySelector(".lightbox-prev");
        var nextBtn = lightbox.querySelector(".lightbox-next");
        var closeBtn = lightbox.querySelector(".lightbox-close");
        var currentIndex = 0;
        var startX = 0;
        var endX = 0;

        function show(index) {
          if (!images.length) {
            return;
          }
          currentIndex = (index + images.length) % images.length;
          imageEl.src = images[currentIndex];
          lightbox.classList.add("active");
          lightbox.setAttribute("aria-hidden", "false");
        }
        function hide() {
          lightbox.classList.remove("active");
          lightbox.setAttribute("aria-hidden", "true");
        }
        function showNext() { show(currentIndex + 1); }
        function showPrev() { show(currentIndex - 1); }

        document.querySelectorAll(".image-thumb").forEach(function (button) {
          button.addEventListener("click", function () {
            var index = parseInt(button.getAttribute("data-index"), 10) || 0;
            show(index);
          });
        });

        prevBtn.addEventListener("click", function (event) {
          event.stopPropagation();
          showPrev();
        });
        nextBtn.addEventListener("click", function (event) {
          event.stopPropagation();
          showNext();
        });
        closeBtn.addEventListener("click", function (event) {
          event.stopPropagation();
          hide();
        });
        lightbox.addEventListener("click", hide);
        lightbox.addEventListener("touchstart", function (event) {
          startX = event.changedTouches[0].screenX;
        });
        lightbox.addEventListener("touchend", function (event) {
          endX = event.changedTouches[0].screenX;
          if (Math.abs(endX - startX) > 40) {
            if (endX < startX) {
              showNext();
            } else {
              showPrev();
            }
          }
        });
        document.addEventListener("keydown", function (event) {
          if (!lightbox.classList.contains("active")) {
            return;
          }
          if (event.key === "Escape") {
            hide();
          } else if (event.key === "ArrowRight") {
            showNext();
          } else if (event.key === "ArrowLeft") {
            showPrev();
          }
        });
      })();
    </script>
  {% endif %}

  <div class="card">
    <h3>{{ t('grade_result') }}</h3>
    {% if grade_result %}
      {% if grade_result.error_message %}
        <p class="status ERROR">{{ t('error') }}: {{ grade_result.error_message }}</p>
        {% if grade_result.raw_response %}
          <h4>{{ t('raw_llm_response') }}</h4>
          <pre>{{ grade_result.raw_response }}</pre>
        {% endif %}
        <h4>{{ t('raw_json') }}</h4>
        <pre>{{ grade_result.json_result }}</pre>
      {% endif %}
      <pre>{{ grade_result.rendered_text }}</pre>
    {% else %}
      <p>{{ t('no_grade_result') }}</p>
    {% endif %}
  </div>

  {% if grade_result %}
    <div class="card">
      <button
        type="button"
        class="secondary"
        data-toggle-target="edit-grade-form"
        data-show-label="{{ t('edit_grade') }}"
        data-hide-label="{{ t('cancel') }}"
      >
        {{ t('edit_grade') }}
      </button>
      <div id="edit-grade-form" class="hidden" style="margin-top: 12px;">
        <h3>{{ t('edit_grade') }}</h3>
        <p class="helper-text">{{ t('edit_grade_hint') }}</p>
        <form method="post" action="{{ url_for('edit_submission_grade', submission_id=submission.id) }}">
          <label for="total_points">{{ t('total_points_override') }}</label>
          <input
            type="text"
            id="total_points"
            name="total_points"
            value="{{ grade_result.total_points if grade_result.total_points is not none else '' }}"
          />
          <label for="rendered_text">{{ t('rendered_feedback') }}</label>
          <textarea id="rendered_text" name="rendered_text">{{ grade_result.rendered_text }}</textarea>
          <button type="submit">{{ t('update_grade') }}</button>
        </form>
      </div>
    </div>
  {% endif %}
  <script>
    (function () {
      var toggle = document.querySelector('[data-toggle-target="edit-grade-form"]');
      var target = document.getElementById("edit-grade-form");
      if (!toggle || !target) {
        return;
      }
      toggle.addEventListener("click", function () {
        var isHidden = target.classList.contains("hidden");
        target.classList.toggle("hidden");
        toggle.textContent = isHidden ? toggle.dataset.hideLabel : toggle.dataset.showLabel;
      });
    })();
  </script>
  <script>
    (function () {
      document.querySelectorAll("[data-toggle-target]").forEach(function (button) {
        var targetId = button.getAttribute("data-toggle-target");
        if (targetId === "edit-grade-form") {
          return;
        }
        var target = document.getElementById(targetId);
        if (!target) {
          return;
        }
        button.addEventListener("click", function () {
          var isHidden = target.classList.contains("hidden");
          target.classList.toggle("hidden");
          button.textContent = isHidden ? button.dataset.hideLabel : button.dataset.showLabel;
        });
      });
    })();
  </script>
{% endblock %}
