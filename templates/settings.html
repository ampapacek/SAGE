{% extends "base.html" %}

{% block content %}
  <div class="card">
    <h2>{{ t('settings') }}</h2>
    <p class="helper-text">{{ t('settings_helper') }}</p>
  </div>

  <div class="card">
    <form method="post">
      {% for field in fields %}
        {% if field.key != "CUSTOM_LLM_PROVIDER_NAME" %}
        <div style="margin-bottom: 16px;">
          <label for="{{ field.key }}">{{ field.label }}</label>
          {% if field.type == "select" and field.key == "LLM_MODEL" %}
            {% set current_value = values[field.key] %}
            {% set is_custom = current_value and current_value not in field.options %}
            <select id="{{ field.key }}" name="{{ field.key }}" class="settings-input">
              {% for option in field.options %}
                {% if option == "other" %}
                  <option value="other" {% if is_custom or current_value == "other" %}selected{% endif %}>{{ t('other_model_option') }}</option>
                {% else %}
                  <option value="{{ option }}" {% if current_value == option %}selected{% endif %}>{{ option }}</option>
                {% endif %}
              {% endfor %}
            </select>
            <div id="settings-custom-model" {% if not is_custom and current_value != "other" %}class="hidden"{% endif %} style="margin-top: 10px;">
              <label for="LLM_MODEL_CUSTOM">{{ t('custom_model_label') }}</label>
              <input
                type="text"
                id="LLM_MODEL_CUSTOM"
                name="LLM_MODEL_CUSTOM"
                value="{% if is_custom %}{{ current_value }}{% endif %}"
                placeholder="{{ t('custom_model_placeholder') }}"
                class="settings-input"
              />
            </div>
          {% elif field.type == "select" and field.key == "LLM_PROVIDER" %}
            {% set provider_value = values[field.key] %}
            <select id="{{ field.key }}" name="{{ field.key }}" class="settings-input">
              {% for option in field.options %}
                {% if option == "other" %}
                  <option value="other" {% if provider_value == "other" %}selected{% endif %}>{{ values["CUSTOM_LLM_PROVIDER_NAME"] or t('provider_other') }}</option>
                {% else %}
                  <option value="{{ option }}" {% if provider_value == option %}selected{% endif %}>{{ t('provider_openai') }}</option>
                {% endif %}
              {% endfor %}
            </select>
            <div id="settings-custom-provider" {% if provider_value != "other" %}class="hidden"{% endif %} style="margin-top: 10px;">
              <label for="CUSTOM_LLM_PROVIDER_NAME">{{ t('provider_other') }}</label>
              <input
                type="text"
                id="CUSTOM_LLM_PROVIDER_NAME"
                name="CUSTOM_LLM_PROVIDER_NAME"
                value="{{ values["CUSTOM_LLM_PROVIDER_NAME"] }}"
                placeholder="{{ t('provider_other') }}"
                class="settings-input"
              />
            </div>
          {% elif field.type == "select" %}
            <select id="{{ field.key }}" name="{{ field.key }}" class="settings-input">
              {% for option in field.options %}
                <option value="{{ option }}" {% if values[field.key] == option %}selected{% endif %}>{{ option }}</option>
              {% endfor %}
            </select>
          {% elif field.type == "checkbox" %}
            <input type="checkbox" id="{{ field.key }}" name="{{ field.key }}" value="1" {% if values[field.key] in ["1", "true", "yes", "on"] %}checked{% endif %} />
          {% else %}
            <input
              type="{{ field.type }}"
              id="{{ field.key }}"
              name="{{ field.key }}"
              value="{{ values[field.key] }}"
              class="settings-input"
            />
          {% endif %}
          {% if field.help %}
            <div class="dropzone-hint">{{ field.help }}</div>
          {% endif %}
          {% if field.restart %}
            <div class="dropzone-hint">{{ t('restart_required') }}</div>
          {% endif %}
        </div>
        {% endif %}
      {% endfor %}
      <button type="submit">{{ t('save_settings') }}</button>
    </form>
  </div>
  <script>
    (function () {
      var modelSelect = document.getElementById("LLM_MODEL");
      var customWrap = document.getElementById("settings-custom-model");
      var providerSelect = document.getElementById("LLM_PROVIDER");
      var providerWrap = document.getElementById("settings-custom-provider");
      if (!modelSelect || !customWrap) {
        return;
      }
      function toggleCustom() {
        customWrap.classList.toggle("hidden", modelSelect.value !== "other");
      }
      function toggleProvider() {
        if (!providerSelect || !providerWrap) {
          return;
        }
        providerWrap.classList.toggle("hidden", providerSelect.value !== "other");
      }
      modelSelect.addEventListener("change", toggleCustom);
      if (providerSelect) {
        providerSelect.addEventListener("change", toggleProvider);
      }
      toggleCustom();
      toggleProvider();
    })();
  </script>
{% endblock %}
