{% extends "base.html" %}

{% block content %}
  <div class="card">
    <h2>{{ t('settings') }}</h2>
    <p class="helper-text">{{ t('settings_helper') }}</p>
  </div>

  <div class="card">
    <form method="post">
      {% for field in base_fields %}
        <div style="margin-bottom: 16px;">
          <label for="{{ field.key }}">{{ field.label }}</label>
          {% if field.type == "select" and field.key == "LLM_MODEL" %}
            {% set provider_value = values["LLM_PROVIDER"] %}
            {% if provider_value == "other" %}
              {% set provider_value = "custom1" %}
            {% endif %}
            {% set current_value = values[field.key] %}
            {% set model_options = provider_model_options.get(provider_value, []) %}
            {% set model_values = model_options | map(attribute='value') | list %}
            {% set is_custom = current_value and current_value not in model_values %}
            <select id="{{ field.key }}" name="{{ field.key }}" class="settings-input">
              {% for option in model_options %}
                <option value="{{ option.value }}" {% if option.supports_images is not none and not option.supports_images %}data-supports-images="false"{% endif %} {% if current_value == option.value %}selected{% endif %}>{{ option.value }}</option>
              {% endfor %}
              <option value="other" {% if is_custom or current_value == "other" %}selected{% endif %}>{{ t('other_model_option') }}</option>
            </select>
            <div id="settings-custom-model" {% if not is_custom and current_value != "other" %}class="hidden"{% endif %} style="margin-top: 10px;">
              <label for="LLM_MODEL_CUSTOM">{{ t('custom_model_label') }}</label>
              <input
                type="text"
                id="LLM_MODEL_CUSTOM"
                name="LLM_MODEL_CUSTOM"
                value="{% if is_custom %}{{ current_value }}{% endif %}"
                placeholder="{{ t('custom_model_placeholder') }}"
                class="settings-input"
              />
            </div>
          {% elif field.type == "select" and field.key == "LLM_PROVIDER" %}
            {% set provider_value = values[field.key] %}
            {% if provider_value == "other" %}
              {% set provider_value = "custom1" %}
            {% endif %}
            <select id="{{ field.key }}" name="{{ field.key }}" class="settings-input">
              {% for option in provider_options %}
                <option value="{{ option.value }}" {% if provider_value == option.value %}selected{% endif %}>{{ option.label }}</option>
              {% endfor %}
            </select>
          {% elif field.type == "select" %}
            <select id="{{ field.key }}" name="{{ field.key }}" class="settings-input">
              {% for option in field.options %}
                <option value="{{ option }}" {% if values[field.key] == option %}selected{% endif %}>{{ option }}</option>
              {% endfor %}
            </select>
          {% elif field.type == "checkbox" %}
            <input type="checkbox" id="{{ field.key }}" name="{{ field.key }}" value="1" {% if values[field.key] in ["1", "true", "yes", "on"] %}checked{% endif %} />
          {% else %}
            <input
              type="{{ field.type }}"
              id="{{ field.key }}"
              name="{{ field.key }}"
              value="{{ values[field.key] }}"
              class="settings-input"
            />
          {% endif %}
          {% if field.help %}
            <div class="dropzone-hint">{{ field.help }}</div>
          {% endif %}
          {% if field.restart %}
            <div class="dropzone-hint">{{ t('restart_required') }}</div>
          {% endif %}
        </div>
      {% endfor %}
      {% for group in provider_groups %}
        <div style="margin-bottom: 8px;">
          <button
            type="button"
            class="secondary"
            data-toggle-target="provider-group-{{ group.id }}"
            data-show-label="{{ t('show_settings') }}"
            data-hide-label="{{ t('hide_settings') }}"
            data-name="{{ group.label }}"
          >
            {% if group.has_info %}
              {{ t('hide_settings') }} {{ group.label }}
            {% else %}
              {{ t('show_settings') }} {{ group.label }}
            {% endif %}
          </button>
        </div>
        <div id="provider-group-{{ group.id }}" {% if not group.has_info %}class="hidden"{% endif %}>
          {% for field in group.fields %}
            <div style="margin-bottom: 16px;">
              <label for="{{ field.key }}">{{ field.label }}</label>
              {% if field.type == "select" %}
                <select id="{{ field.key }}" name="{{ field.key }}" class="settings-input">
                  {% for option in field.options %}
                    <option value="{{ option }}" {% if values[field.key] == option %}selected{% endif %}>{{ option }}</option>
                  {% endfor %}
                </select>
              {% elif field.type == "checkbox" %}
                <input type="checkbox" id="{{ field.key }}" name="{{ field.key }}" value="1" {% if values[field.key] in ["1", "true", "yes", "on"] %}checked{% endif %} />
              {% else %}
                <input
                  type="{{ field.type }}"
                  id="{{ field.key }}"
                  name="{{ field.key }}"
                  value="{{ values[field.key] }}"
                  class="settings-input"
                />
              {% endif %}
              {% if field.help %}
                <div class="dropzone-hint">{{ field.help }}</div>
              {% endif %}
              {% if field.restart %}
                <div class="dropzone-hint">{{ t('restart_required') }}</div>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      {% endfor %}
      <button type="submit">{{ t('save_settings') }}</button>
    </form>
  </div>
  <script>
    (function () {
      var providerSelect = document.getElementById("LLM_PROVIDER");
      var modelSelect = document.getElementById("LLM_MODEL");
      var customWrap = document.getElementById("settings-custom-model");
      var customInput = document.getElementById("LLM_MODEL_CUSTOM");
      var providerModelOptions = {{ provider_model_options | tojson }};
      var providerDefaultModels = {{ provider_default_models | tojson }};
      var otherLabel = "{{ t('other_model_option') }}";
      if (!modelSelect || !customWrap) {
        return;
      }
      function toggleCustom() {
        customWrap.classList.toggle("hidden", modelSelect.value !== "other");
      }
      function selectedModelValue() {
        if (modelSelect.value === "other" && customInput && customInput.value.trim()) {
          return customInput.value.trim();
        }
        return modelSelect.value || "";
      }
      function preferredModel(providerKey) {
        var current = selectedModelValue();
        var lastProvider = modelSelect.dataset.lastProvider || providerKey;
        if (lastProvider !== providerKey) {
          return providerDefaultModels[providerKey] || "";
        }
        return current;
      }
      function rebuildOptions(providerKey, selectedValue) {
        if (providerKey === "other") {
          providerKey = "custom1";
        }
        var options = providerModelOptions[providerKey] || [];
        modelSelect.innerHTML = "";
        options.forEach(function (opt) {
          var option = document.createElement("option");
          option.value = opt.value;
          option.textContent = opt.value;
          if (opt.supports_images === false) {
            option.dataset.supportsImages = "false";
          }
          modelSelect.appendChild(option);
        });
        var otherOption = document.createElement("option");
        otherOption.value = "other";
        otherOption.textContent = otherLabel;
        modelSelect.appendChild(otherOption);
        var hasMatch = options.some(function (opt) {
          return opt.value === selectedValue;
        });
        if (selectedValue && hasMatch) {
          modelSelect.value = selectedValue;
        } else if (!selectedValue && options.length) {
          modelSelect.value = options[0].value;
        } else {
          modelSelect.value = "other";
        }
        if (customInput) {
          if (selectedValue && !hasMatch) {
            customInput.value = selectedValue;
          } else if (modelSelect.value !== "other") {
            customInput.value = "";
          }
        }
      }
      function refreshModels() {
        var providerKey = providerSelect ? providerSelect.value : "openai";
        if (providerKey === "other") {
          providerKey = "custom1";
        }
        rebuildOptions(providerKey, preferredModel(providerKey));
        modelSelect.dataset.lastProvider = providerKey;
        toggleCustom();
      }
      if (providerSelect) {
        providerSelect.addEventListener("change", refreshModels);
      }
      modelSelect.addEventListener("change", toggleCustom);
      refreshModels();

      var toggles = document.querySelectorAll("[data-toggle-target]");
      toggles.forEach(function (button) {
        var targetId = button.getAttribute("data-toggle-target");
        var target = document.getElementById(targetId);
        var name = button.getAttribute("data-name") || "";
        function syncLabel() {
          var showLabel = button.getAttribute("data-show-label") || "Show settings for";
          var hideLabel = button.getAttribute("data-hide-label") || "Hide settings for";
          var hidden = target && target.classList.contains("hidden");
          button.textContent = (hidden ? showLabel : hideLabel) + " " + name;
        }
        if (!target) {
          return;
        }
        button.addEventListener("click", function () {
          target.classList.toggle("hidden");
          syncLabel();
        });
        syncLabel();
      });
    })();
  </script>
{% endblock %}
