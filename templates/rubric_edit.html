{% extends "base.html" %}

{% block content %}
  <style>
    .guide-part-editor {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 12px;
      background: var(--card);
    }
    .guide-part-editor textarea {
      min-height: 90px;
    }
  </style>
  <div class="card">
    <h2>{{ t('edit_guide') }}</h2>
    <form method="post">
      {% if rubric_edit_data %}
        <input type="hidden" name="structured_editor" value="1" />
        <label>{{ t('total_points') }}</label>
        <div id="total-points-display" class="dropzone-hint" style="margin-bottom: 12px;">
          {% if rubric_edit_data.computed_total is not none %}
            {{ rubric_edit_data.computed_total }}
          {% else %}
            --
          {% endif %}
        </div>
        <div id="parts-editor">
          {% for part in rubric_edit_data.parts %}
            <div class="guide-part-editor">
              <label>{{ t('part_label') }}</label>
              <input
                type="text"
                name="part_id"
                value="{{ part.part_id }}"
                class="settings-input"
              />
              <label>{{ t('max_points') }}</label>
              <input
                type="number"
                step="1"
                name="part_max_points"
                value="{% if part.max_points is not none %}{{ part.max_points }}{% endif %}"
                class="settings-input"
              />
              <label>{{ t('criteria_one_per_line') }}</label>
              <textarea name="part_criteria">{% for item in part.criteria %}{{ item }}{% if not loop.last %}&#10;{% endif %}{% endfor %}</textarea>
            </div>
          {% endfor %}
        </div>
        <button type="button" class="secondary" id="add-part">{{ t('add_part') }}</button>
      {% else %}
        <label for="rubric_text">{{ t('guide_text') }}</label>
        <textarea id="rubric_text" name="rubric_text" required>{{ rubric.rubric_text }}</textarea>
      {% endif %}
      <label for="reference_solution_text">{{ t('reference_solution') }}</label>
      {% if reference_edit_data %}
        <input type="hidden" name="reference_structured" value="1" />
        <div class="dropzone-hint" style="margin-bottom: 10px;">{{ t('reference_line_hint') }}</div>
        <div id="reference-editor">
          {% for part in reference_edit_data.parts %}
            <div class="guide-part-editor">
              <label>{{ t('part_label') }}</label>
              <input
                type="text"
                name="reference_part_id"
                value="{{ part.part_id }}"
                class="settings-input"
              />
              <label>{{ t('reference_solution') }}</label>
              <textarea name="reference_content">{% for line in part.content_lines %}{{ line }}{% if not loop.last %}&#10;{% endif %}{% endfor %}</textarea>
            </div>
          {% endfor %}
        </div>
        <button type="button" class="secondary" id="add-reference-part">{{ t('add_reference_part') }}</button>
      {% else %}
        <textarea id="reference_solution_text" name="reference_solution_text" required>{{ rubric.reference_solution_text }}</textarea>
      {% endif %}
      <button type="submit">{{ t('save_changes') }}</button>
      <a class="action-link" href="{{ url_for('rubric_detail', rubric_id=rubric.id) }}">{{ t('cancel') }}</a>
    </form>
  </div>
  {% if rubric_edit_data %}
    <div id="part-template" class="guide-part-editor hidden">
      <label>{{ t('part_label') }}</label>
      <input type="text" name="part_id" class="settings-input" />
      <label>{{ t('max_points') }}</label>
      <input type="number" step="1" name="part_max_points" class="settings-input" />
      <label>{{ t('criteria_one_per_line') }}</label>
      <textarea name="part_criteria"></textarea>
    </div>
    <script>
      (function () {
        var addBtn = document.getElementById("add-part");
        var container = document.getElementById("parts-editor");
        var template = document.getElementById("part-template");
        var totalDisplay = document.getElementById("total-points-display");
        if (!addBtn || !container || !template) {
          return;
        }
        function updateTotal() {
          if (!totalDisplay) {
            return;
          }
          var inputs = container.querySelectorAll('input[name="part_max_points"]');
          var total = 0;
          var hasValue = false;
          inputs.forEach(function (input) {
            var value = parseFloat(input.value);
            if (!isNaN(value)) {
              total += value;
              hasValue = true;
            }
          });
          totalDisplay.textContent = hasValue ? total : "--";
        }
        addBtn.addEventListener("click", function () {
          var clone = template.cloneNode(true);
          clone.classList.remove("hidden");
          clone.removeAttribute("id");
          container.appendChild(clone);
          updateTotal();
        });
        container.addEventListener("input", function (event) {
          if (event.target && event.target.name === "part_max_points") {
            updateTotal();
          }
        });
        updateTotal();
      })();
    </script>
  {% endif %}
  {% if reference_edit_data %}
    <div id="reference-template" class="guide-part-editor hidden">
      <label>{{ t('part_label') }}</label>
      <input type="text" name="reference_part_id" class="settings-input" />
      <label>{{ t('reference_solution') }}</label>
      <textarea name="reference_content"></textarea>
    </div>
    <script>
      (function () {
        var addBtn = document.getElementById("add-reference-part");
        var container = document.getElementById("reference-editor");
        var template = document.getElementById("reference-template");
        if (!addBtn || !container || !template) {
          return;
        }
        addBtn.addEventListener("click", function () {
          var clone = template.cloneNode(true);
          clone.classList.remove("hidden");
          clone.removeAttribute("id");
          container.appendChild(clone);
        });
      })();
    </script>
  {% endif %}
{% endblock %}
