{% extends "base.html" %}

{% block content %}
  <style>
    .guide-part-editor {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 12px;
      background: var(--card);
    }
    .guide-part-editor textarea {
      min-height: 90px;
    }
  </style>
  <div class="card">
    <h2>{{ t('edit_guide') }}</h2>
    <form method="post">
      {% if rubric_edit_data %}
        <input type="hidden" name="structured_editor" value="1" />
        <label for="total_points">{{ t('total_points') }}</label>
        <input
          type="number"
          step="0.01"
          id="total_points"
          name="total_points"
          value="{% if rubric_edit_data.total_points is not none %}{{ rubric_edit_data.total_points }}{% endif %}"
          class="settings-input"
        />
        <div id="parts-editor">
          {% for part in rubric_edit_data.parts %}
            <div class="guide-part-editor">
              <label>{{ t('part_label') }}</label>
              <input
                type="text"
                name="part_id"
                value="{{ part.part_id }}"
                class="settings-input"
              />
              <label>{{ t('max_points') }}</label>
              <input
                type="number"
                step="0.01"
                name="part_max_points"
                value="{% if part.max_points is not none %}{{ part.max_points }}{% endif %}"
                class="settings-input"
              />
              <label>{{ t('criteria_one_per_line') }}</label>
              <textarea name="part_criteria">{% for item in part.criteria %}{{ item }}{% if not loop.last %}&#10;{% endif %}{% endfor %}</textarea>
            </div>
          {% endfor %}
        </div>
        <button type="button" class="secondary" id="add-part">{{ t('add_part') }}</button>
      {% else %}
        <label for="rubric_text">{{ t('guide_text') }}</label>
        <textarea id="rubric_text" name="rubric_text" required>{{ rubric.rubric_text }}</textarea>
      {% endif %}
      <label for="reference_solution_text">{{ t('reference_solution') }}</label>
      <textarea id="reference_solution_text" name="reference_solution_text" required>{{ rubric.reference_solution_text }}</textarea>
      <button type="submit">{{ t('save_changes') }}</button>
      <a class="action-link" href="{{ url_for('rubric_detail', rubric_id=rubric.id) }}">{{ t('cancel') }}</a>
    </form>
  </div>
  {% if rubric_edit_data %}
    <div id="part-template" class="guide-part-editor hidden">
      <label>{{ t('part_label') }}</label>
      <input type="text" name="part_id" class="settings-input" />
      <label>{{ t('max_points') }}</label>
      <input type="number" step="0.01" name="part_max_points" class="settings-input" />
      <label>{{ t('criteria_one_per_line') }}</label>
      <textarea name="part_criteria"></textarea>
    </div>
    <script>
      (function () {
        var addBtn = document.getElementById("add-part");
        var container = document.getElementById("parts-editor");
        var template = document.getElementById("part-template");
        if (!addBtn || !container || !template) {
          return;
        }
        addBtn.addEventListener("click", function () {
          var clone = template.cloneNode(true);
          clone.classList.remove("hidden");
          clone.removeAttribute("id");
          container.appendChild(clone);
        });
      })();
    </script>
  {% endif %}
{% endblock %}
