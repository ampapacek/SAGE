{% extends "base.html" %}

{% block content %}
  <div class="card">
    <h2>{{ t('guide') }} {{ rubric.id }}</h2>
    <p>{{ t('assignment') }}: <a href="{{ url_for('assignment_detail', assignment_id=assignment.id) }}">{{ assignment.title }}</a></p>
    <button
      type="button"
      class="secondary"
      data-toggle-target="assignment-text"
      data-show-label="{{ t('show_assignment_text') }}"
      data-hide-label="{{ t('hide_assignment_text') }}"
    >
      {{ t('hide_assignment_text') }}
    </button>
    <div id="assignment-text" style="margin-top: 12px;">
      <div class="markdown assignment-text">{{ assignment_html | safe }}</div>
    </div>
    <p>{{ t('status') }}: <span class="status {{ rubric.status }}">{{ rubric.status }}</span></p>
    <p>{{ t('provider') }}: {{ provider_display }}</p>
    <p>{{ t('model') }}: {{ rubric.llm_model or 'manual' }}</p>
    <p>{{ t('created') }}: {{ rubric.created_at.strftime('%b %d, %Y %H:%M') }}</p>
    {% if duration_seconds is not none %}
      <p>{{ t('duration_s') }}: {{ "%.2f"|format(duration_seconds) }}</p>
    {% endif %}
    {% if show_costs and rubric.price_estimate is not none %}
      <p>{{ t('price_estimate') }}: <span class="price-amount" data-usd="{{ "%.6f"|format(rubric.price_estimate) }}">${{ "%.4f"|format(rubric.price_estimate) }}</span></p>
    {% endif %}
    {% if rubric.error_message %}
      <p class="status ERROR">{{ t('error') }}: {{ rubric.error_message }}</p>
    {% endif %}
    {% if rubric.status in ['DRAFT', 'APPROVED'] %}
      <a class="action-link" href="{{ url_for('edit_rubric', rubric_id=rubric.id) }}">{{ t('edit_guide') }}</a>
    {% endif %}
  </div>

  <div class="card">
    <h3>{{ t('guide_text') }}</h3>
    {% if rubric_structured %}
      <div class="guide-structured">
        {% if rubric_structured.total_points is not none %}
          <p><strong>{{ t('total_points') }}:</strong> {{ rubric_structured.total_points }}</p>
        {% endif %}
        {% set parts = rubric_structured.get('parts') %}
        {% if parts %}
          <table class="guide-table">
            <thead>
              <tr>
                <th>{{ t('part_label') }}</th>
                <th>{{ t('max_points') }}</th>
                <th>{{ t('criteria') }}</th>
              </tr>
            </thead>
            <tbody>
              {% if parts is mapping %}
                {% for part_id, part in parts.items() %}
                  <tr>
                    <td>{{ part_id }}</td>
                    <td>{{ part.max_points or part.points_possible or part.points or '--' }}</td>
                    <td>
                      {% set criteria = part.criteria %}
                      {% if criteria is sequence and criteria is not string %}
                        <ul class="guide-list">
                          {% for item in criteria %}
                            <li>{{ item }}</li>
                          {% endfor %}
                        </ul>
                      {% elif criteria %}
                        {{ criteria }}
                      {% else %}
                        --
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              {% elif parts is sequence and parts is not string %}
                {% for part in parts %}
                  <tr>
                    <td>{{ part.part_id or loop.index }}</td>
                    <td>{{ part.max_points or part.points_possible or part.points or '--' }}</td>
                    <td>
                      {% set criteria = part.criteria %}
                      {% if criteria is sequence and criteria is not string %}
                        <ul class="guide-list">
                          {% for item in criteria %}
                            <li>{{ item }}</li>
                          {% endfor %}
                        </ul>
                      {% elif criteria %}
                        {{ criteria }}
                      {% else %}
                        --
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              {% endif %}
            </tbody>
          </table>
        {% endif %}
      </div>
    {% else %}
      <pre>{{ rubric.rubric_text or 'Not available yet.' }}</pre>
    {% endif %}
  </div>

  <div class="card">
    <h3>{{ t('reference_solution') }}</h3>
    {% if reference_structured %}
      <div class="guide-structured">
        {% for part_id, part in reference_structured.items() %}
          <div class="guide-part">
            <h4 style="margin: 0 0 6px;">{{ t('part_label') }} {{ part_id }}</h4>
            {% if part is mapping %}
              <ul class="guide-list">
                {% for key, value in part.items() %}
                  <li>
                    <strong>{{ key|replace('_', ' ')|title }}:</strong>
                    {% if value is sequence and value is not string %}
                      {{ value|join(', ') }}
                    {% else %}
                      {{ value }}
                    {% endif %}
                  </li>
                {% endfor %}
              </ul>
            {% elif part is sequence and part is not string %}
              <ul class="guide-list">
                {% for item in part %}
                  <li>{{ item }}</li>
                {% endfor %}
              </ul>
            {% else %}
              <p style="margin: 0;">{{ part }}</p>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% else %}
      <pre>{{ rubric.reference_solution_text or 'Not available yet.' }}</pre>
    {% endif %}
  </div>

  {% if rubric.error_message and rubric.raw_response %}
    <div class="card">
      <h3>{{ t('raw_llm_response') }}</h3>
      <pre>{{ rubric.raw_response }}</pre>
    </div>
  {% endif %}

  <div class="card">
    {% if rubric.status == 'DRAFT' %}
      <form method="post" action="{{ url_for('approve_rubric', rubric_id=rubric.id) }}">
        <button type="submit">{{ t('approve_guide') }}</button>
      </form>
    {% elif rubric.status == 'ARCHIVED' %}
      <form method="post" action="{{ url_for('approve_rubric', rubric_id=rubric.id) }}">
        <button type="submit" class="secondary">{{ t('activate_guide') }}</button>
      </form>
    {% elif rubric.status == 'GENERATING' %}
      <form method="post" action="{{ url_for('cancel_rubric', rubric_id=rubric.id) }}">
        <button type="submit" class="secondary">{{ t('cancel_generation') }}</button>
      </form>
    {% elif rubric.status == 'ERROR' %}
      <form method="post" action="{{ url_for('rerun_rubric', rubric_id=rubric.id) }}">
        <button type="submit" class="secondary">{{ t('rerun_guide') }}</button>
      </form>
    {% elif rubric.status == 'APPROVED' %}
      <p>{{ t('approved_guide_in_use') }}</p>
    {% else %}
      <p>{{ t('guide_not_ready') }}</p>
    {% endif %}
  </div>
  <script>
    (function () {
      var toggle = document.querySelector('[data-toggle-target="assignment-text"]');
      var target = document.getElementById("assignment-text");
      if (!toggle || !target) {
        return;
      }
      toggle.addEventListener("click", function () {
        var isHidden = target.classList.contains("hidden");
        target.classList.toggle("hidden");
        toggle.textContent = isHidden ? toggle.dataset.hideLabel : toggle.dataset.showLabel;
      });
    })();
  </script>
{% endblock %}
