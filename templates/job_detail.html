{% extends "base.html" %}

{% block content %}
  <div class="card">
    <h2>{{ t('job') }} {{ job.id }}</h2>
    <p>{{ t('status') }}: <span id="job-status" class="status {{ job.status }}">{{ job.status }}</span></p>
    <p>{{ t('provider') }}: {{ job_provider_display }}</p>
    <p>{{ t('model') }}: {{ job.llm_model or 'unknown' }}</p>
    <p>{{ t('submission_number') }} <a href="{{ url_for('submission_detail', submission_id=job.submission_id) }}">{{ job.submission_id }}</a></p>
    <div class="helper-text">{{ t('student_hint') }}</div>
    <p>{{ t('student') }}: {{ job.submission.student_identifier if job.submission else 'unknown' }}</p>
    <p>{{ t('guide_version') }}: <a href="{{ url_for('rubric_detail', rubric_id=job.rubric_version_id) }}">{{ job.rubric_version_id }}</a></p>
    <p>{{ t('created') }}: {{ job.created_at.strftime('%b %d, %Y %H:%M') }}</p>
    {% if job.started_at %}
      <p>{{ t('started') }}: {{ job.started_at.strftime('%b %d, %Y %H:%M') }}</p>
    {% endif %}
    {% if job.finished_at %}
      <p>{{ t('finished') }}: {{ job.finished_at.strftime('%b %d, %Y %H:%M') }}</p>
    {% endif %}
    {% if duration_seconds is not none %}
      <p>{{ t('duration_s') }}: <span id="job-duration">{{ "%.2f"|format(duration_seconds) }}</span></p>
    {% else %}
      <p>{{ t('duration_s') }}: <span id="job-duration">--</span></p>
    {% endif %}
    {% if job_price_display is not none %}
      <p>{{ t('price_estimate') }}: <span class="price-amount" data-usd="{{ "%.6f"|format(job_price_display) }}">${{ "%.4f"|format(job_price_display) }}</span></p>
    {% endif %}
    {% if job.message %}
      <button type="button" class="secondary" id="toggle-summary" data-show="{{ t('show_processing_summary') }}" data-hide="{{ t('hide_processing_summary') }}">{{ t('show_processing_summary') }}</button>
      <div id="processing-summary" class="hidden">
        <h3>{{ t('processing_summary') }}</h3>
        <pre>{{ job.message }}</pre>
      </div>
    {% endif %}
    {% if job.status in ['QUEUED', 'RUNNING'] %}
      <form method="post" action="{{ url_for('terminate_job', job_id=job.id) }}">
        <button type="submit" class="secondary">{{ t('terminate_job') }}</button>
      </form>
    {% endif %}
    {% if job.status not in ['QUEUED', 'RUNNING'] %}
      <form method="post" action="{{ url_for('delete_job', job_id=job.id) }}" onsubmit="return confirm('Delete this job?');">
        <button type="submit" class="danger">{{ t('delete_job') }}</button>
      </form>
    {% endif %}
    <form method="post" action="{{ url_for('rerun_job', job_id=job.id) }}">
      <label for="llm_provider">{{ t('provider_label') }}</label>
      <select id="llm_provider" name="llm_provider" class="compact-select">
        {% set selected_provider = job.llm_provider or default_provider %}
        <option value="openai" {% if selected_provider == 'openai' %}selected{% endif %}>{{ t('provider_openai') }}</option>
        <option value="other" {% if selected_provider == 'other' %}selected{% endif %}>{{ custom_provider_name }}</option>
      </select>
      <label for="llm_model">{{ t('model_options') }}</label>
      <select id="llm_model" name="llm_model" class="compact-select">
        {% set selected_model = job.llm_model or default_model %}
        {% set known_models = ['gpt-4o-mini','gpt-5-mini','gpt-4o','gpt-4.1','gpt-4.1-mini','o4-mini','o3-mini','gpt-5','gpt-5-nano'] %}
        {% set is_custom = selected_provider == 'other' or selected_model not in known_models %}
        <option value="gpt-4o-mini" data-supports-images="true" {% if selected_model == 'gpt-4o-mini' %}selected{% endif %}>gpt-4o-mini</option>
        <option value="gpt-5-mini" data-supports-images="true" {% if selected_model == 'gpt-5-mini' %}selected{% endif %}>gpt-5-mini</option>
        <option value="gpt-4o" data-supports-images="true" {% if selected_model == 'gpt-4o' %}selected{% endif %}>gpt-4o</option>
        <option value="gpt-4.1" data-supports-images="true" {% if selected_model == 'gpt-4.1' %}selected{% endif %}>gpt-4.1</option>
        <option value="gpt-4.1-mini" data-supports-images="true" {% if selected_model == 'gpt-4.1-mini' %}selected{% endif %}>gpt-4.1-mini</option>
        <option value="o4-mini" data-supports-images="true" {% if selected_model == 'o4-mini' %}selected{% endif %}>o4-mini</option>
        <option value="o3-mini" data-supports-images="false" {% if selected_model == 'o3-mini' %}selected{% endif %}>o3-mini</option>
        <option value="gpt-5" data-supports-images="true" {% if selected_model == 'gpt-5' %}selected{% endif %}>gpt-5</option>
        <option value="gpt-5-nano" data-supports-images="true" {% if selected_model == 'gpt-5-nano' %}selected{% endif %}>gpt-5-nano</option>
        <option value="other" {% if is_custom %}selected{% endif %}>{{ t('other_model_option') }}</option>
      </select>
      <div id="custom_model_wrap" {% if not is_custom %}class="hidden"{% endif %}>
        <label for="custom_llm_model">{{ t('custom_model_label') }}</label>
        <input
          type="text"
          id="custom_llm_model"
          name="custom_llm_model"
          value="{% if is_custom %}{{ selected_model }}{% endif %}"
          placeholder="{{ t('custom_model_placeholder') }}"
        />
      </div>
      <button type="submit">{{ t('rerun_job') }}</button>
    </form>
    <script>
      (function () {
        var providerSelect = document.getElementById("llm_provider");
        var modelSelect = document.getElementById("llm_model");
        var customWrap = document.getElementById("custom_model_wrap");
        if (!modelSelect || !customWrap) {
          return;
        }
        function toggleCustom() {
          customWrap.classList.toggle("hidden", modelSelect.value !== "other");
        }
        function syncProvider() {
          if (providerSelect && providerSelect.value === "other") {
            modelSelect.value = "other";
          }
        }
        if (providerSelect) {
          providerSelect.addEventListener("change", function () {
            syncProvider();
            toggleCustom();
          });
        }
        modelSelect.addEventListener("change", toggleCustom);
        syncProvider();
        toggleCustom();
      })();
    </script>
    {% if submission_requires_images %}
      <script>
        (function () {
          var providerSelect = document.getElementById("llm_provider");
          var modelSelect = document.getElementById("llm_model");
          if (!modelSelect) {
            return;
          }
          var options = modelSelect.options;
          var firstEnabled = null;
          if (providerSelect && providerSelect.value === "other") {
            return;
          }
          for (var i = 0; i < options.length; i++) {
            var option = options[i];
            var disabled = option.dataset.supportsImages === "false";
            option.disabled = disabled;
            if (!disabled && firstEnabled === null) {
              firstEnabled = option.value;
            }
          }
          if (
            modelSelect.selectedOptions.length &&
            modelSelect.selectedOptions[0].disabled &&
            firstEnabled !== null
          ) {
            modelSelect.value = firstEnabled;
          }
        })();
      </script>
    {% endif %}
    {% if grade_result and grade_result.error_message and grade_result.raw_response %}
      <h3>{{ t('raw_llm_response_error') }}</h3>
      <pre>{{ grade_result.raw_response }}</pre>
    {% endif %}
  </div>
  {% if job.message %}
    <script>
      (function () {
        var button = document.getElementById("toggle-summary");
        var panel = document.getElementById("processing-summary");
        if (!button || !panel) {
          return;
        }
        button.addEventListener("click", function () {
          var isHidden = panel.classList.contains("hidden");
          panel.classList.toggle("hidden");
          button.textContent = isHidden ? button.dataset.hide : button.dataset.show;
        });
      })();
    </script>
  {% endif %}
  {% if auto_refresh %}
    <script>
      (function () {
        var statusUrl = "{{ url_for('job_status', job_id=job.id) }}";
        var statusEl = document.getElementById("job-status");
        var durationEl = document.getElementById("job-duration");
        if (!statusEl || !durationEl) {
          return;
        }
        var intervalId = setInterval(function () {
          fetch(statusUrl)
            .then(function (response) { return response.json(); })
            .then(function (data) {
              if (!data) {
                return;
              }
              if (data.status) {
                statusEl.textContent = data.status;
                statusEl.className = "status " + data.status;
              }
              if (data.duration_seconds !== null && data.duration_seconds !== undefined) {
                durationEl.textContent = Number(data.duration_seconds).toFixed(2);
              }
              if (data.status && data.status !== "QUEUED" && data.status !== "RUNNING") {
                clearInterval(intervalId);
                window.location.reload();
              }
            })
            .catch(function () {});
        }, 4000);
      })();
    </script>
  {% endif %}
{% endblock %}
